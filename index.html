<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Duck Hunt 2025</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
:root {
/* Core Palette */
--green: #60A34D;
--pink: #ff69b4;
--gold: #FFD700;

/* UPDATED: iOS 26 Inspired UI Kit with softer shadow */
--background-start: #1c0f29;
--background-end: #0c0a15;
--glass-bg: rgba(255, 255, 255, 0.08);
--glass-blur: 24px;
--glass-border-top: rgba(255, 255, 255, 0.25);
--glass-border-bottom: rgba(255, 255, 255, 0.05);
/* SOLUTION: Tighter, less diffuse shadow to prevent blending */
--glass-shadow: none; /* Shadow removed */
--inset-shadow: inset 0 1px 1px 0 rgba(255, 255, 255, 0.1);
--highlight-color: #ffffff;
--glow-color: rgba(96, 163, 77, 0.8);
--active-glow: 0 0 12px rgba(96, 163, 77, 0.9);

/* Sizing and Spacing */
--tab-bar-height: 65px;
--safe-padding: 1rem;
--ribbon-height: 40px;
--frosted-black: rgba(0, 0, 0, 0.75);
}

body {
margin: 0;
background-color: #000;
overflow-x: hidden;
min-height: 100vh;
min-height: 100svh;
font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
color: white;
text-align: center;
position: relative;
}
.hidden { display: none !important; }

/* Classic Spinner */
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.button-group button .spinner { width: 18px; height: 18px; border-width: 3px; }

/* iOS 26 Glass Card Style */
.glass-card {
background: var(--glass-bg);
backdrop-filter: blur(var(--glass-blur));
-webkit-backdrop-filter: blur(var(--glass-blur));
border: 1px solid var(--glass-border-bottom);
border-top-color: var(--glass-border-top);
border-radius: 20px;
box-shadow: var(--glass-shadow); /* Shadow removed here */
padding: 1.5rem;
}

.transparent-heading-box { background: none; border: none; border-radius: 10px; padding: 0.75rem 0; margin: 0 auto 1.5rem auto; width: 100%; max-width: 450px; box-sizing: border-box; text-align: center; }
#app-wrapper {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
display: flex;
flex-direction: column;
padding-top: var(--ribbon-height);
transition: padding-top 0.3s ease;
}
#app-wrapper.ribbon-active {
padding-top: var(--ribbon-height);
}
#ribbon-message {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: var(--ribbon-height);
background-color: rgba(30, 30, 30, 0.5);
backdrop-filter: blur(15px);
-webkit-backdrop-filter: blur(15px);
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
font-weight: bold;
font-size: 0.85rem;
display: flex;
align-items: center;
overflow: hidden;
z-index: 1000;
box-sizing: border-box;
transition: transform 0.3s ease-out;
transform: translateY(-100%);
}
#ribbon-message.visible {
transform: translateY(0);
}
#ribbon-content {
white-space: nowrap;
display: flex;
align-items: center;
will-change: transform;
color: var(--gold);
height: 100%;
}
#ribbon-content span {
color: white;
font-weight: normal;
padding-left: 8px;
}
.marquee-start {
animation-name: marquee-scroll;
animation-timing-function: linear;
animation-iteration-count: infinite;
}
@keyframes marquee-scroll {
from { transform: translateX(0); }
to { transform: translateX(var(--marquee-distance)); }
}
#app-container {
flex: 1;
overflow-y: auto;
height: calc(100svh - var(--tab-bar-height) - var(--ribbon-height));
padding-bottom: calc(var(--safe-padding) + var(--tab-bar-height));
}
.app-page {
width: 100%;
min-height: 100%;
box-sizing: border-box;
padding: 0 var(--safe-padding);
display: none;
flex-direction: column;
gap: 0;
align-items: center;
}
.app-page.active { display: flex; }
.app-page h2 { margin: 0; flex-shrink: 0; text-align: center; }
.app-page .header-image-top {
width: 70%;
max-width: 250px;
margin: 0.2rem auto 0.2rem auto;
display: block;
flex-shrink: 0;
}
#hunt-page { justify-content: flex-start; padding-top: 0; }
#info-page, #map-page, #leaderboard-page, #log-page { justify-content: flex-start; padding-top: 0; }
#hunt-content-wrapper {
position: relative;
width: 100%;
max-width: 350px;
display: flex;
flex-direction: column;
gap: 0.75rem;
align-items: center;
margin-top: 0;
flex-shrink: 0;
}
#qr-reader-container { padding: 0; display: flex; position: relative; width: 100%; aspect-ratio: 1 / 1; max-width: 300px; }
#qr-reader { width: 100%; height: 100%; border-radius: 20px; overflow: hidden; }
#qr-reader-container.error-flash { animation: flash-red 0.5s ease; }
@keyframes flash-red { 0%, 100% { box-shadow: 0 0 10px rgba(0,0,0,0.5); } 50% { box-shadow: var(--glass-shadow), 0 0 25px rgba(255, 0, 0, 0.9); } }
.point-pop {
position: absolute;
top: 85%;
left: 50%;
transform: translate(-50%, -50%);
font-size: 1.5rem;
font-weight: 800;
color: #FFFFFF;
background: rgba(0, 0, 0, 0.7);
border: 2px solid #FFFFFF;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
padding: 0.5rem 1.5rem;
border-radius: 5px;
min-width: 250px;
text-shadow: 0 0 5px rgba(255,255,255,0.5);
animation: float-up-short 3s ease-out forwards;
pointer-events: none;
}
@keyframes float-up-short { 0% { top: 85%; opacity: 1; } 50% { top: 70%; opacity: 1; } 100% { top: 70%; opacity: 0; } }
#golden-flash-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: var(--gold);
z-index: 1001;
opacity: 0;
pointer-events: none;
}
@keyframes gold-flash {
0% { opacity: 0; }
10% { opacity: 0.9; }
50% { opacity: 0.4; }
100% { opacity: 0; }
}
.golden-point-pop {
border-color: var(--gold) !important;
color: var(--gold) !important;
background: rgba(10, 10, 10, 0.9) !important;
box-shadow: 0 0 15px var(--gold), 0 0 5px rgba(255, 215, 0, 0.5) !important;
text-shadow: 0 0 8px #fff !important;
font-size: 1.8rem !important;
}
.footer-logo {
height: 50px;
margin: 0 auto 5px auto;
display: block;
object-fit: contain;
}
#scanner-footer-details {
display: flex;
flex-direction: column;
align-items: center;
gap: 0.75rem;
margin-top: 0.5rem;
flex-shrink: 0;
}
#scan-history-link {
font-size: 1.1rem;
color: var(--green);
text-decoration: underline;
cursor: pointer;
margin-top: 0;
font-weight: bold;
}
#player-rank-display { margin-top: 0; font-size: 1.1rem; font-weight: 600; }

/* --- MAP STYLES --- */
#map-page {
    padding-top: var(--safe-padding);
    justify-content: flex-start;
}
#map-card-container {
    width: 100%;
    max-width: 450px;
    height: 65vh;
    overflow: scroll;
    padding: 0;
    border-radius: 20px;
}
#map-wrapper {
    position: relative;
    width: 250vw;
    height: auto;
}
#campus-map-img {
    width: 100%;
    height: auto;
    display: block;
}
#map-markers-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}
.map-label {
    position: absolute;
    z-index: 10;
    transform: translate(-50%, -50%);
    cursor: default;
    pointer-events: auto;
    background: rgba(30, 30, 30, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 3px 6px; /* Smaller padding */
    min-width: 90px; /* Adjusted min-width */
    text-align: center;
    /* Removed box-shadow here */
    white-space: normal;
    line-height: 1.2; /* Adjusted line height */
    transition: transform 0.2s ease-out;
}
.map-label h4 {
    margin: 0;
    font-size: 12px; /* Smaller font size */
    font-weight: bold;
    color: white;
}
.map-label p {
    margin: 0;
    padding-top: 2px; /* Smaller padding */
    font-size: 10px; /* Smaller font size */
    color: rgba(255, 255, 255, 0.9);
}
.map-label.cleared {
    border-color: #ff4d4d;
    background-color: rgba(50, 50, 50, 0.85);
    opacity: 0.8;
}
/* --- End Map Styles --- */

#log-container, #leaderboard-container, #info-container {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    padding: var(--safe-padding) 0;
    background: none;
    border: none;
    box-shadow: none;
    gap: 0.75rem;
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 450px;
    margin: 0 auto;
}

#leaderboard-list, #log-list {
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

#info-modal-backdrop {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.5);
backdrop-filter: blur(10px);
z-index: 200;
display: none;
align-items: center;
justify-content: center;
}
#info-modal {
position: relative;
width: 90%;
max-width: 400px;
padding: 1.5rem;
}
#modal-close-btn {
position: absolute;
top: 10px;
right: 10px;
background: none;
border: none;
color: white;
font-size: 2rem;
cursor: pointer;
}
#modal-title {
margin-top: 0;
border-bottom: 2px solid var(--green);
padding-bottom: 0.5rem;
}
#modal-content {
text-align: left;
padding: 0 0.5rem;
}
#modal-content ul {
list-style-type: disc;
padding-left: 25px;
}
#modal-content li {
margin-bottom: 0.5rem;
}
.info-card-button {
padding: 1rem 1.5rem;
width: 100%;
text-align: center;
cursor: pointer;
transition: transform 0.2s ease;
margin-bottom: 0.75rem;
box-sizing: border-box;
}
.info-card-button:hover {
transform: scale(1.03);
}
.info-card-button h4 {
margin: 0;
font-size: 1.2rem;
font-weight: bold;
color: white;
}
.list-item {
display: flex;
align-items: center;
justify-content: space-between;
padding: 1rem;
border-radius: 12px;
}
#leaderboard-list .list-item > div:first-child { display: flex; align-items: center; gap: 0.75rem; }
.list-item .rank-text {
font-weight: bold;
font-size: 1.2rem;
white-space: nowrap;
}
#leaderboard-list .list-item span {
font-weight: bold;
font-size: 1.3rem;
color: var(--green);
}
#log-list .list-item > div:first-child { display: flex; flex-direction: column; align-items: flex-start; }
#log-list .list-item .primary-text { font-weight: bold; font-size: 1.1rem; margin-bottom: 0; }
#log-list .list-item .secondary-text { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 0.2rem; }
.button-group { display: flex; gap: 0.5rem; }
.button-group button, .full-width-btn { flex: 1; border-radius: 10px; padding: 12px 15px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border: 1px solid var(--glass-border-bottom); border-top-color: var(--glass-border-top); transition: all 0.2s ease; box-shadow: var(--inset-shadow); min-height: 48px; box-sizing: border-box; display: flex; justify-content: center; align-items: center; }
.primary-btn { background-color: var(--green); color: white; border-color: rgba(255, 255, 255, 0.3); }
.secondary-btn { background-color: rgba(255, 255, 255, 0.1); color: white; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.primary-btn:hover, .secondary-btn:hover, .full-width-btn:hover { box-shadow: var(--inset-shadow), 0 0 10px var(--glow-color); border-color: var(--green); transform: translateY(-2px); }

/* === LAVA CONTAINER STYLES === */
#lava-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
}
#lava-container::before, #lava-container::after {
    content: '';
    position: absolute;
    width: 70vmax;
    height: 70vmax;
    border-radius: 50%;
    opacity: 0.8;
    mix-blend-mode: lighten;
    filter: blur(120px);
}
#lava-container::before {
    background-color: var(--pink);
    top: -35vmax;
    left: -35vmax;
    animation: move-pink 14s infinite linear;
}
#lava-container::after {
    background-color: var(--green);
    bottom: -35vmax;
    right: -35vmax;
    animation: move-green 12s infinite linear;
    animation-delay: -8s;
}
/* === END LAVA STYLES === */

.screen { opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
.screen.visible { opacity: 1; pointer-events: auto; }
#login-screen { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.reg-input, #login-studentid { background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border-bottom); border-top-color: var(--glass-border-top); border-radius: 10px; padding: 12px 15px; font-size: 1rem; color: white; text-align: center; transition: all 0.2s ease; box-shadow: var(--inset-shadow); }
.reg-input:focus, #login-studentid:focus { outline: none; border-color: var(--green); box-shadow: var(--inset-shadow), 0 0 10px var(--glow-color); }
#instructions-card { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); padding: 0.8rem 1.2rem; border-radius: 12px; width: 90%; max-width: 450px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; z-index: 101; }
#header-card { position: relative; width: 85%; max-width: 300px; margin-bottom: 1.5rem; }
#login-view, #registration-view { display: flex; flex-direction: column; gap: 1.5rem; }
.input-group { display: flex; flex-direction: column; gap: 1rem; }

footer {
position: absolute;
bottom: 0;
left: 0;
right: 0;
padding: 10px 10px 20px 10px;
color: rgba(255, 255, 255, 0.7);
font-size: 0.8rem;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}
.footer-logo {
height: 50px;
margin: 0 auto 5px auto;
display: block;
object-fit: contain;
}
footer p { margin: 2px 0; }
#scanner-overlay-stats { position: absolute; top: 0; left: 0; right: 0; z-index: 10; background: rgba(0, 0, 0, 0.35); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px 20px 0 0; border-bottom: 1px solid var(--glass-border-top); padding: 0.8rem; display: flex; justify-content: space-around; }
.stat { text-align: center; }
.stat h4 { margin: 0; color: rgba(255,255,255,0.7); font-weight: bold; font-size: 0.9rem; }
.stat p { margin: 0; font-size: 1.2rem; font-weight: bold; transition: all 0.3s ease; }
.stat p.pending-update {
    animation: pulse-green 1.5s infinite;
}
@keyframes pulse-green {
    0% { color: white; text-shadow: none; }
    50% { color: var(--green); text-shadow: 0 0 8px var(--green); }
    100% { color: white; text-shadow: none; }
}
#tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--tab-bar-height); z-index: 150; background: rgba(30, 30, 30, 0.5); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-top: 1px solid var(--glass-border-top); display: flex; justify-content: space-around; }
.tab-button {
background: none;
border: none;
color: rgba(255, 255, 255, 0.6);
font-size: 0.9rem;
cursor: pointer;
flex-grow: 1;
font-weight: 600;
transition: color 0.3s ease;
}
.tab-button.active { color: var(--highlight-color); font-weight: bold; text-shadow: 0 0 8px var(--green); }
.duck-animation { position: absolute; top: 50%; left: -50px; font-size: 50px; animation: fly-across 2s linear forwards; pointer-events: none; z-index: 1000; }
.frost-animation { position: absolute; top: -20px; font-size: 1.5rem; color: white; pointer-events: none; z-index: 999; animation: fall-and-fade linear forwards; }
@keyframes fly-across { 0% { transform: translateX(0) translateY(0) rotate(0deg); } 25% { transform: translateX(25vw) translateY(-40px) rotate(15deg); } 50% { transform: translateX(50vw) translateY(0) rotate(0deg); } 75% { transform: translateX(75vw) translateY(-40px) rotate(-15deg); } 100% { transform: translateX(110vw) translateY(0) rotate(0deg); } }
@keyframes fall-and-fade { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }

/* === BACKGROUND KEYFRAMES === */
@keyframes move-pink { 
    0%, 100% { transform: translate(0, 0); } 
    25% { transform: translate(calc(100vw - 70vmax), 0); } 
    50% { transform: translate(calc(100vw - 70vmax), calc(100vh - 70vmax)); } 
    75% { transform: translate(0, calc(100vh - 70vmax)); } 
}
@keyframes move-green { 
    0%, 100% { transform: translate(0, 0); } 
    25% { transform: translate(calc(-100vw + 70vmax), 0); } 
    50% { transform: translate(calc(-100vw + 70vmax), calc(-100vh + 70vmax)); } 
    75% { transform: translate(0, calc(-100vh + 70vmax)); } 
}
/* === END KEYFRAMES === */

#duck-feet-background-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: -2;
pointer-events: none;
overflow: hidden;
opacity: 0.5;
}
.fading-duck-feet {
position: absolute;
width: 50px;
height: 50px;
background-image: url('https://i.imgur.com/S23b6Wc.png');
background-size: contain;
background-repeat: no-repeat;
opacity: 0;
animation: fade-in-out linear forwards;
pointer-events: none;
}
@keyframes fade-in-out {
0% { opacity: 0; transform: scale(0.8); }
20% { opacity: 0.3; transform: scale(1); }
80% { opacity: 0.3; transform: scale(1); }
100% { opacity: 0; transform: scale(1.2); }
}

@media (max-width: 480px) {
    .map-label {
        min-width: 90px;
        padding: 4px 8px;
    }
    .map-label h4 {
        font-size: 12px;
    }
    .map-label p {
        font-size: 10px;
        padding-top: 2px;
    }
}

/* --- NEW STYLES FOR TORCH AND LOGOUT --- */
#torch-toggle-btn {
    position: absolute;
    bottom: 15px;
    right: 15px;
    width: 45px;
    height: 45px;
    background-color: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 50%;
    cursor: pointer;
    z-index: 15;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    transition: background-color 0.2s, transform 0.2s;
}
#torch-toggle-btn:hover {
    transform: scale(1.1);
}
#torch-toggle-btn.torch-on {
    background-color: rgba(255, 255, 255, 0.85);
}
#torch-toggle-btn svg {
    width: 24px;
    height: 24px;
    fill: white;
    transition: fill 0.2s;
}
#torch-toggle-btn.torch-on svg {
    fill: #000;
}

#logout-btn {
    background-color: rgba(255, 100, 100, 0.1);
    border-color: rgba(255, 100, 100, 0.2);
    color: rgba(255, 150, 150, 1);
    margin: 1.5rem 0;
}
#logout-btn:hover {
    background-color: rgba(255, 100, 100, 0.2);
    border-color: rgba(255, 100, 100, 0.4);
    box-shadow: var(--inset-shadow), 0 0 10px rgba(255, 100, 100, 0.4);
    transform: translateY(-2px);
}
</style>
</head>
<body>
<div id="golden-flash-overlay" class="hidden"></div>
<div id="ribbon-message">
<div id="ribbon-content"></div>
</div>
<div id="lava-container"></div>
<div id="duck-feet-background-container"></div>
<div id="login-screen" class="screen visible">
<div class="glass-card" id="instructions-card">
<p>Tap <img src="https://i.imgur.com/wFrSvUH.png" alt="Share Icon" style="height:1.2em; vertical-align:middle; margin: 0 0.2em;"> to Add to Home Screen!</p>
<button id="close-instructions" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
</div>
<div class="glass-card" id="header-card">
<div id="login-view">
<img class="header-image" style="width:100%;" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<input type="text" id="login-studentid" class="reg-input" placeholder="Student ID">
<div class="button-group">
<button id="signin-btn" class="secondary-btn">Sign In</button>
<button id="register-btn" class="primary-btn">Register</button>
</div>
</div>
<div id="registration-view" class="hidden">
<h3 style="text-align: center;">Welcome To The Hunt!</h3>
<div class="input-group">
<input type="text" id="reg-firstname" class="reg-input" placeholder="First Name"><input type="text" id="reg-lastname" class="reg-input" placeholder="Last Name">
<input type="text" id="reg-studentid" class="reg-input" placeholder="Student ID"><input type="email" id="reg-email" class="reg-input" placeholder="Email @my.gcu.edu">
</div>
<div class="button-group">
<button id="back-btn" class="secondary-btn">Back</button><button id="submit-btn" class="primary-btn">Submit</button>
</div>
</div>
</div>
<footer>
<img src="https://i.imgur.com/p2qZOL5.png" alt="Canyon Activities Board Logo" class="footer-logo">
<p>Follow Us At <b>@CABGCU</b> On Instagram</p>
<p>Hosted by the Canyon Activities Board at Grand Canyon University</p>
</footer>
</div>
<div id="app-wrapper" class="screen">
<main id="app-container">
<section id="hunt-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<div id="hunt-content-wrapper">
<h2 class="transparent-heading-box" id="welcome-message"></h2>
<div id="qr-reader-container" class="glass-card">
<div id="scanner-overlay-stats">
<div class="stat"><h4>POINTS</h4><p id="player-points">0</p></div>
<div class="stat"><h4>DUCKS</h4><p id="player-ducks">0</p></div>
</div>
<div id="qr-reader"></div>
<button id="torch-toggle-btn" class="hidden">
    <svg viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M9,2A1,1 0 0,0 8,3V4A1,1 0 0,0 9,5H15A1,1 0 0,0 16,4V3A1,1 0 0,0 15,2H9M9,6A1,1 0 0,0 8,7V8A1,1 0 0,0 9,9H15A1,1 0 0,0 16,8V7A1,1 0 0,0 15,6H9M8,10V20A2,2 0 0,0 10,22H14A2,2 0 0,0 16,20V10H8Z"></path>
    </svg>
</button>
</div>
<div id="scanner-footer-details">
<a id="scan-history-link" href="#" data-page="log-page">Scan History</a>
<div id="player-rank-display"></div>
</div>
</div>
</section>

<section id="map-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<div id="map-card-container">
    <div id="map-wrapper">
        <img id="campus-map-img"
        src="https://i.imgur.com/1aQCsPk.jpeg"
        alt="Interactive Campus Map">
        <div id="map-markers-overlay"></div>
    </div>
</div>
</section>

<section id="leaderboard-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<h2 class="transparent-heading-box">Leaderboard</h2>
<div id="leaderboard-container"><ul id="leaderboard-list"></ul></div>
</section>
<section id="log-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<h2 class="transparent-heading-box">Scan History</h2>
<div id="log-container"><ul id="log-list"></ul></div>
</section>
<section id="info-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<h2 class="transparent-heading-box">Information</h2>
<div id="info-container"></div>
<button id="logout-btn" class="full-width-btn">Logout</button>
</section>
</main>
<nav id="tab-bar">
<button class="tab-button" data-page="hunt-page">Scanner</button>
<button class="tab-button" data-page="leaderboard-page">Leaderboard</button>
<button class="tab-button" data-page="map-page">Map</button>
<button class="tab-button" data-page="info-page">Info</button>
</nav>
</div>
<div id="info-modal-backdrop" style="display: none;">
<div id="info-modal" class="glass-card">
<button id="modal-close-btn">&times;</button>
<h3 id="modal-title"></h3>
<div id="modal-content"></div>
</div>
</div>
<script>
// --- CONFIGURATION ---
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyzgyRQZe5Y2A3W8YkVRwCPv7OAseEHpSDcBzUjy-EEAn9kXc2TWMOi4UtTTUz4PROD/exec';
const POPUP_DURATION_MS = 2000;
const BATCH_SEND_INTERVAL_MS = 15000;
const DATA_REFRESH_INTERVAL_MS = 30000;
const VIRTUAL_LIMIT = 10;
const VIRTUAL_LOCATIONS = ['Commuter Lounge', 'Thunderground', 'Riverbed'];
const MAP_SPOTS = [
{ name: 'The Grove', dataKey: 'The Grove', coords: '1295,758,1311,774' },
{ name: 'Lopes Way', dataKey: 'Lopes Way', coords: '2270,1911,2286,1927' }, 
{ name: 'Main Campus', dataKey: 'Main Campus', coords: '1763,2398,1779,2414' },
{ name: 'North Campus', dataKey: 'North Campus', coords: '2738,1116,2754,1132' },
{ name: 'East Campus', dataKey: 'East Campus', coords: '3882,2468,3898,2484' },
{ name: 'The Rivers', dataKey: 'The Rivers', coords: '4757,1136,4773,1152' },
{ name: 'Riverbed Virtual', dataKey: 'Riverbed', coords: '5125,817,5141,833' }, 
{ name: 'Commuter Lounge Virtual', dataKey: 'Commuter Lounge', coords: '1355,1900,1371,1916' }, 
{ name: 'Thunderground Virtual', dataKey: 'Thunderground', coords: '1514,1680,1530,1696' },
];

// --- GLOBAL STATE & DOM REFERENCES ---
let html5QrCode = null;
let currentUser = null;
let initialDuckId = null;
let infoDataCache = [];
let infoDataFetchTime = null;
let mapResizeObserver = null;
const loginScreen = document.getElementById('login-screen');
const appWrapper = document.getElementById('app-wrapper');
const loginView = document.getElementById('login-view');
const registrationView = document.getElementById('registration-view');
const ribbonMessage = document.getElementById('ribbon-message');
const mapImageElement = document.getElementById('campus-map-img');

// --- CACHING & STATE ---
let duckDataCache = {};
let claimedDucksCache = new Set();
let processingDucks = new Set();
let localVirtualScanTimestamps = [];
let scanHistoryCache = [];
let scanQueue = [];
let batchSendTimer = null;
let dataRefreshTimer = null;
let locationCountsCache = {}; 
let pendingPoints = 0;
let pendingDucks = 0;

// --- MAP INTERACTION LOGIC ---
const mapCardContainer = document.getElementById('map-card-container');
let isPanning = false;

function updateLabelSizeOnPan() {
    if (!isPanning) return;

    const viewportCenterX = mapCardContainer.scrollLeft + mapCardContainer.clientWidth / 2;
    const viewportCenterY = mapCardContainer.scrollTop + mapCardContainer.clientHeight / 2;
    const maxDistance = Math.sqrt(Math.pow(mapCardContainer.clientWidth / 2, 2) + Math.pow(mapCardContainer.clientHeight / 2, 2));

    document.querySelectorAll('.map-label').forEach(label => {
        const labelCenterX = label.offsetLeft + (label.offsetWidth / 2);
        const labelCenterY = label.offsetTop + (label.offsetHeight / 2);

        const distance = Math.sqrt(Math.pow(labelCenterX - viewportCenterX, 2) + Math.pow(labelCenterY - viewportCenterY, 2));

        const scale = 1.15 - (distance / maxDistance) * 0.25;

        label.style.transform = `translate(-50%, -50%) scale(${Math.max(0.9, Math.min(scale, 1.15))})`;
    });

    isPanning = false;
}

function positionMarkers() {
const overlay = document.getElementById('map-markers-overlay');
if (!overlay || !mapImageElement || mapImageElement.naturalWidth === 0) return;

overlay.innerHTML = ''; 
const locationData = locationCountsCache; 

MAP_SPOTS.forEach(spot => {
const marker = document.createElement('div');
marker.className = 'map-label'; 

const [x1, y1, x2, y2] = spot.coords.split(',').map(Number);
const centerX = (x1 + x2) / 2;
const centerY = (y1 + y2) / 2;

marker.style.left = `${(centerX / mapImageElement.naturalWidth) * 100}%`;
marker.style.top = `${(centerY / mapImageElement.naturalHeight) * 100}%`;

const dataKey = spot.dataKey; 
const displayName = spot.name; 

let remainingText;
let spotData = locationData[dataKey]; 

if (!spotData) {
remainingText = '<strong>N/A</strong> Codes Left';
marker.style.borderColor = 'gray'; 
} else {
const remaining = spotData.count;
if (remaining > 0) {
remainingText = `🦆 <strong>${remaining}</strong> Codes Left`;
marker.style.borderColor = 'var(--green)';
} else {
remainingText = `❌ <strong>CLEARED</strong>`;
marker.classList.add('cleared');
}
}

marker.innerHTML = `<h4>${displayName}</h4><p>${remainingText}</p>`;
overlay.appendChild(marker);
});
isPanning = true;
updateLabelSizeOnPan();
}

async function updateDuckMapData() {
    const result = await postToAction('getDuckCounts');

    if (result.status === 'success' && result.locations) {
        locationCountsCache = {};
        Object.keys(result.locations).forEach(name => {
            locationCountsCache[name] = { count: result.locations[name] };
        });
    }
}

function initializeMap() {
    if (mapResizeObserver) {
        mapResizeObserver.disconnect();
        mapResizeObserver = null;
    }

    mapCardContainer.addEventListener('scroll', () => {
        if (!isPanning) {
            isPanning = true;
            window.requestAnimationFrame(updateLabelSizeOnPan);
        }
    });

    const imageLoadPromise = new Promise(resolve => {
        if (mapImageElement.complete && mapImageElement.naturalWidth > 0) {
            resolve();
        } else {
            mapImageElement.onload = null;
            mapImageElement.onerror = null; 
            
            mapImageElement.onload = resolve;
            mapImageElement.onerror = resolve; 
        }
    });

    Promise.all([imageLoadPromise, updateDuckMapData()]).then(() => {
        if (mapImageElement.naturalWidth > 0) {
            positionMarkers();
            
            if (!mapResizeObserver) {
                mapResizeObserver = new ResizeObserver(positionMarkers);
                mapResizeObserver.observe(mapImageElement);
            }
        } else {
            console.error("Map image failed to load or has zero dimensions.");
        }
    });
}
// --- END MAP INTERACTION LOGIC ---

// --- FETCH HELPER ---
async function postToAction(action, payload = {}) {
try {
const response = await fetch(SCRIPT_URL, {
method: 'POST',
body: JSON.stringify({ action, ...payload })
});
if (!response.ok) {
throw new Error(`Network response was not ok: ${response.statusText}`);
}
return await response.json();
} catch (error) {
console.error(`Fetch error for action "${action}":`, error);
return { status: "error", message: "Network error or script failure." };
}
}
// --- RIBBON DISPLAY FUNCTION ---
function updateRibbon(ribbonText) {
const ribbonContent = document.getElementById('ribbon-content');
const scrollSpeed = 25;
ribbonContent.style.animation = 'none';
ribbonContent.style.transform = 'translateX(0)';
ribbonContent.style.paddingLeft = '100%';
if (ribbonText && ribbonText.trim() !== '') {
ribbonContent.innerHTML = `📢<span>${ribbonText}</span>`;
ribbonMessage.classList.add('visible');
appWrapper.classList.add('ribbon-active');
setTimeout(() => {
const contentWidth = ribbonContent.scrollWidth;
const viewWidth = ribbonMessage.clientWidth;
if (contentWidth > viewWidth) {
const totalDistance = contentWidth;
const duration = totalDistance / scrollSpeed;
ribbonContent.style.setProperty('--marquee-distance', `-${totalDistance}px`);
ribbonContent.style.animation = `marquee-scroll ${duration}s linear infinite`;
ribbonContent.style.paddingLeft = `${viewWidth}px`;
ribbonContent.style.textAlign = 'left';
} else {
ribbonContent.style.paddingLeft = '0';
ribbonContent.style.textAlign = 'center';
const centeredPadding = (viewWidth - ribbonContent.offsetWidth) / 2;
ribbonContent.style.paddingLeft = `${Math.max(0, centeredPadding)}px`;
ribbonContent.style.transform = 'translateX(0)';
ribbonContent.style.animation = 'none';
}
}, 10);
} else {
ribbonContent.innerHTML = '';
ribbonMessage.classList.remove('visible');
appWrapper.classList.remove('ribbon-active');
ribbonContent.style.animation = 'none';
}
}
// --- ANIMATION FUNCTIONS ---
function startRandomFadingDuckFeet() {
const container = document.getElementById('duck-feet-background-container');
const maxFeetOnScreen = 7;
const minDelay = 1000;
const maxDelay = 3000;
const animationDuration = 6000;
function createFadingFeet() {
const currentFeet = container.querySelectorAll('.fading-duck-feet');
if (currentFeet.length >= maxFeetOnScreen) {
currentFeet[0].remove();
}
const feet = document.createElement('div');
feet.className = 'fading-duck-feet';
const randomX = Math.random() * (window.innerWidth - 60);
const randomY = Math.random() * (window.innerHeight - 60);
feet.style.left = `${randomX}px`;
feet.style.top = `${randomY}px`;
const randomScale = 0.7 + Math.random() * 0.6;
feet.style.transform = `scale(${randomScale}) rotate(${Math.random() * 360}deg)`;
feet.style.animationDuration = `${animationDuration}ms`;
container.appendChild(feet);
setTimeout(() => {
feet.remove();
}, animationDuration);
const nextDelay = Math.random() * (maxDelay - minDelay) + minDelay;
setTimeout(createFadingFeet, nextDelay);
}
createFadingFeet();
}
function triggerDuckAnimation() {
const duckCount = Math.floor(Math.random() * 5) + 3;
for (let i = 0; i < duckCount; i++) {
setTimeout(() => {
const duck = document.createElement('div');
duck.textContent = '🦆';
duck.className = 'duck-animation';
duck.style.top = `${30 + Math.random() * 40}%`;
duck.style.animationDuration = `${1.5 + Math.random()}s`;
document.body.appendChild(duck);
setTimeout(() => duck.remove(), 2500);
}, i * 150);
}
}
function triggerGoldenDuckAnimation() {
const flash = document.getElementById('golden-flash-overlay');
flash.classList.remove('hidden');
flash.style.animation = 'gold-flash 0.8s ease-out forwards';
const emojis = ['🦆', '🥇', '💰', '✨'];
const count = 10;
for (let i = 0; i < count; i++) {
setTimeout(() => {
const item = document.createElement('div');
item.textContent = emojis[Math.floor(Math.random() * emojis.length)];
item.className = 'frost-animation';
item.style.fontSize = `${1.5 + Math.random() * 2.5}rem`;
item.style.color = '#FFD700';
item.style.left = `${Math.random() * 100}vw`;
item.style.animationDuration = `${1.5 + Math.random() * 2.5}s`;
item.style.animationDelay = `${Math.random() * 0.5}s`;
document.body.appendChild(item);
setTimeout(() => item.remove(), 5000);
}, 150 + i * 50);
}
setTimeout(() => {
flash.classList.add('hidden');
flash.style.animation = 'none';
}, 850);
}
function triggerFrostAnimation() {
const flakeCount = 15;
for (let i = 0; i < flakeCount; i++) {
const flake = document.createElement('div');
flake.textContent = '❄️';
flake.className = 'frost-animation';
flake.style.left = `${Math.random() * 100}vw`;
flake.style.animationDuration = `${2 + Math.random() * 3}s`;
flake.style.animationDelay = `${Math.random()}s`;
document.body.appendChild(flake);
setTimeout(() => flake.remove(), 5000);
}
}
// --- CORE SCANNING & SYNC LOGIC ---
function updateOptimisticDisplay() {
    if (!currentUser) return;
    const pointsEl = document.getElementById('player-points');
    const ducksEl = document.getElementById('player-ducks');

    const totalPoints = (currentUser.points || 0) + pendingPoints;
    const totalDucks = (currentUser.duckCount || 0) + pendingDucks;

    pointsEl.textContent = totalPoints;
    ducksEl.textContent = totalDucks;

    if (pendingPoints > 0 || pendingDucks > 0) {
        pointsEl.classList.add('pending-update');
        ducksEl.classList.add('pending-update');
    } else {
        pointsEl.classList.remove('pending-update');
        ducksEl.classList.remove('pending-update');
    }
}

async function onScanSuccess(decodedText) {
    if (!currentUser) return;
    
    const triggerVisualError = () => {
        const qrContainer = document.getElementById('qr-reader-container');
        qrContainer.classList.add('error-flash');
        setTimeout(() => qrContainer.classList.remove('error-flash'), 500);
    };

    let finalDuckId = decodedText;
    try {
        const url = new URL(decodedText);
        if (url.searchParams.has('duckId')) { finalDuckId = url.searchParams.get('duckId'); }
    } catch (e) {}
    const lookupId = finalDuckId.trim().toLowerCase();

    if (claimedDucksCache.has(lookupId) || processingDucks.has(lookupId)) {
        triggerVisualError(); 
        return;
    }
    
    const duckInfo = duckDataCache[lookupId];
    if (!duckInfo) {
        triggerVisualError();
        return;
    }

    processingDucks.add(lookupId); 
    
    if (duckInfo.type === 'Virtual Duck') {
        const oneDayAgo = new Date().getTime() - (24 * 60 * 60 * 1000);
        localVirtualScanTimestamps = localVirtualScanTimestamps.filter(ts => ts > oneDayAgo);
        
        if (localVirtualScanTimestamps.length >= VIRTUAL_LIMIT) { 
            triggerVisualError(); 
            displayErrorPopup(`Daily limit of ${VIRTUAL_LIMIT} Virtual Ducks reached.`);
            triggerFrostAnimation();
            processingDucks.delete(lookupId);
            return;
        }
        localVirtualScanTimestamps.push(new Date().getTime());
    }

    scanQueue.push({ duckId: finalDuckId, studentId: currentUser.studentId });
    
    const points = duckInfo.points || 0;
    pendingPoints += points;
    pendingDucks += 1;
    updateOptimisticDisplay();
    
    const isGoldenDuck = duckInfo.type === 'Golden Duck';
    displaySuccessPopup(`+${points}`, isGoldenDuck); 
    if (isGoldenDuck) {
        triggerGoldenDuckAnimation();
    } else {
        triggerDuckAnimation();
    }
}

async function sendBatchScans() {
    if (scanQueue.length === 0) return;
    
    const scansToSend = [...scanQueue];
    scanQueue = [];
    
    const sentDuckIds = new Set(scansToSend.map(s => s.duckId.trim().toLowerCase())); 

    const batchResult = await postToAction('batchScanDucks', { scans: scansToSend });
    
    sentDuckIds.forEach(id => processingDucks.delete(id));

    if (batchResult.status === "success") {
        if (batchResult.updatedUser) {
            currentUser.points = batchResult.updatedUser.points;
            currentUser.duckCount = batchResult.updatedUser.duckCount;
            pendingPoints = 0;
            pendingDucks = 0;
            updateOptimisticDisplay();
        }
        
        if (batchResult.results) {
            batchResult.results.forEach(result => {
                const id = result.duckId.trim().toLowerCase();
                
                if (result.status === "success") {
                    claimedDucksCache.add(id); 
                } else {
                    displayRevertPopup(result.message || "A duck was claimed just before you!");
                }
            });
        }
    } else {
        displayRevertPopup(batchResult.message || "A server error occurred.");
        scanQueue = [...scansToSend, ...scanQueue];
    }
}

function periodicDataRefresh() {
if (!currentUser) return;
updateUserDashboard(true); 

postToAction('getClaimedDucks').then(result => {
if (result.status === 'success' && Array.isArray(result.claimed)) {
claimedDucksCache = new Set(result.claimed);
}
});
const fiveMinutes = 5 * 60 * 1000;
if (!infoDataFetchTime || (new Date() - infoDataFetchTime > fiveMinutes)) {
    postToAction('getInfoData').then(result => {
        if (result.status === 'success') {
            updateRibbon(result.ribbonText);
            infoDataCache = result.infoItems || [];
            infoDataFetchTime = new Date();
            if (document.getElementById('info-page').classList.contains('active')) {
                renderInfoCards(infoDataCache);
            }
        } else {
            updateRibbon('');
        }
    });
}
}

// --- APP INITIALIZATION & LOGIN ---
async function showApp(user, initialPageId, loginButtonEl, loginButtonContent) {
    currentUser = user;
    currentUser.duckCount = user.duckCount || 0; 
    sessionStorage.setItem('currentUserStudentId', user.studentId);
    
    try {
        const [duckResult, claimedDucksResult] = await Promise.all([
            postToAction('getDuckData'),
            postToAction('getClaimedDucks')
        ]);
        
        if (duckResult.status === "success") {
            duckDataCache = duckResult.ducks;
        } else { throw new Error("Failed to load duck data."); }
        
        if (claimedDucksResult.status === "success" && Array.isArray(claimedDucksResult.claimed)) {
            claimedDucksCache = new Set(claimedDucksResult.claimed);
        }
    } catch (e) {
        console.error("Failed to load critical game data:", e);
        alert("Could not load critical game data. Please try again.");
        
        if (loginButtonEl) {
            loginButtonEl.innerHTML = loginButtonContent;
            loginButtonEl.disabled = false;
        }
        return; 
    }

    if (loginButtonEl) {
        loginButtonEl.innerHTML = loginButtonContent;
        loginButtonEl.disabled = false;
    }
    
    loginScreen.classList.remove('visible');
    appWrapper.classList.add('visible');
    
    if (batchSendTimer) clearInterval(batchSendTimer);
    batchSendTimer = setInterval(sendBatchScans, BATCH_SEND_INTERVAL_MS);
    if (dataRefreshTimer) clearInterval(dataRefreshTimer);
    dataRefreshTimer = setInterval(periodicDataRefresh, DATA_REFRESH_INTERVAL_MS);
    
    switchPage(initialPageId); 
    
    if (initialDuckId) {
        onScanSuccess(initialDuckId);
        initialDuckId = null;
    }

    try {
        const [historyResult, infoResult] = await Promise.all([
            postToAction('getScanHistory', { studentId: currentUser.studentId }),
            postToAction('getInfoData')
        ]);
        
        if (Array.isArray(historyResult)) {
            scanHistoryCache = historyResult;
            currentUser.duckCount = historyResult.length;
            const oneDayAgo = new Date().getTime() - (24 * 60 * 60 * 1000);
            localVirtualScanTimestamps = historyResult
                .filter(scan => scan.duckType === 'Virtual Duck' && new Date(scan.timestamp).getTime() > oneDayAgo)
                .map(scan => new Date(scan.timestamp).getTime());
        }
        
        if (infoResult.status === 'success') {
            updateRibbon(infoResult.ribbonText);
            infoDataCache = infoResult.infoItems || [];
            infoDataFetchTime = new Date();
            if (document.getElementById('info-page').classList.contains('active')) {
                renderInfoCards(infoDataCache);
            }
        }
    } catch (e) {
        console.error("Failed to load auxiliary data in background:", e);
    }
    
    await updateUserDashboard();
}

async function signIn(studentId) {
    const signinBtn = document.getElementById('signin-btn');
    const originalContent = signinBtn.innerHTML;
    
    signinBtn.innerHTML = '<div class="spinner"></div>';
    signinBtn.disabled = true;

    const result = await postToAction('getUser', { studentId });
    
    if (result.status === "success") {
        showApp(result.user, 'hunt-page', signinBtn, originalContent); 
    } else {
        signinBtn.innerHTML = originalContent;
        signinBtn.disabled = false;
        alert("User not found! Please register before signing in.");
    }
}

async function registerUser() {
    const submitBtn = document.getElementById('submit-btn');
    const originalContent = submitBtn.innerHTML;

    const payload = {
        firstName: document.getElementById('reg-firstname').value.trim(),
        lastName: document.getElementById('reg-lastname').value.trim(),
        studentId: document.getElementById('reg-studentid').value.trim(),
        email: document.getElementById('reg-email').value.trim()
    };
    
    if (!payload.firstName || !payload.studentId) {
        return alert("First Name and Student ID are required.");
    }
    if (!payload.email.toLowerCase().endsWith('@my.gcu.edu')) {
        return alert("Registration requires an @my.gcu.edu email address.");
    }
    
    submitBtn.innerHTML = '<div class="spinner"></div>';
    submitBtn.disabled = true;

    try {
        const result = await postToAction('registerUser', payload);
        
        if (result.status === "success") {
            const userResult = await postToAction('getUser', { studentId: payload.studentId });
            if (userResult.status === "success") {
                showApp(userResult.user, 'hunt-page', submitBtn, originalContent);
            } else {
                throw new Error("Auto sign-in failed after registration.");
            }
        } else {
            submitBtn.innerHTML = originalContent;
            submitBtn.disabled = false;
            alert(result.message);
        }
    } catch (error) {
        submitBtn.innerHTML = originalContent;
        submitBtn.disabled = false;
        alert("Error registering. Please check your Student ID and try again.");
    }
}
// --- UI & DATA DISPLAY FUNCTIONS ---
function displaySuccessPopup(message, isGolden = false) {
const successPop = document.createElement('div');
successPop.className = 'point-pop';
if (isGolden) {
successPop.classList.add('golden-point-pop');
}
successPop.textContent = message;
document.getElementById('qr-reader-container').appendChild(successPop);
setTimeout(() => successPop.remove(), POPUP_DURATION_MS);
}
function displayErrorPopup(message) {
const errorPop = document.createElement('div');
errorPop.className = 'point-pop';
errorPop.style.background = '#d9534f';
errorPop.textContent = message;
document.getElementById('qr-reader-container').appendChild(errorPop);
setTimeout(() => errorPop.remove(), POPUP_DURATION_MS);
}
function displayRevertPopup(message) {
const revertPop = document.createElement('div');
revertPop.className = 'point-pop';
revertPop.style.background = '#f0ad4e';
revertPop.innerHTML = `<strong>Points Reverted</strong><br><small>${message}</small>`;
document.getElementById('qr-reader-container').appendChild(revertPop);
setTimeout(() => revertPop.remove(), POPUP_DURATION_MS + 1000);
}
async function updateUserDashboard(shouldUpdatePoints = true) {
if (!currentUser) return;
try {
    const fetches = [
        postToAction('getLeaderboard'),
        postToAction('getScanHistory', { studentId: currentUser.studentId })
    ];
    if (shouldUpdatePoints) {
        fetches.unshift(postToAction('getUser', { studentId: currentUser.studentId }));
    }
    const responses = await Promise.all(fetches);

    let userResult, leaderboardData, historyResult;
        
    const hasPendingScans = scanQueue.length > 0;
            
    if (shouldUpdatePoints && !hasPendingScans) {
        userResult = responses.shift();
        if (userResult.status === "success") {
            currentUser.points = userResult.user.points;
            currentUser.duckCount = userResult.user.duckCount;
        }
    } else if (shouldUpdatePoints) {
        responses.shift(); 
    }
    updateOptimisticDisplay();

    const leaderboardIndex = shouldUpdatePoints ? 0 : 0;
    const historyIndex = shouldUpdatePoints ? 1 : 1; 

    leaderboardData = responses[leaderboardIndex];
    historyResult = responses[historyIndex];

    document.getElementById('welcome-message').textContent = `Welcome, ${currentUser.firstName}!`;

    if (Array.isArray(leaderboardData)) {
        const myRank = leaderboardData.findIndex(p => String(p.studentId).trim() === String(currentUser.studentId).trim()) + 1;
        let rankText = myRank > 0 ? `Rank: ${myRank}` : 'Not Yet Ranked';
        if (myRank === 1) rankText = '🥇 Rank 1';
        else if (myRank === 2) rankText = '🥈 Rank 2';
        else if (myRank === 3) rankText = '🥉 Rank 3';
        document.getElementById('player-rank-display').textContent = rankText;
    }

    if (Array.isArray(historyResult)) {
        scanHistoryCache = historyResult;
        if (!hasPendingScans) {
            currentUser.duckCount = historyResult.length;
            updateOptimisticDisplay();
        }
    }
        
} catch (e) {
    console.error("Failed to update dashboard", e);
}
}
async function updateLeaderboard() {
const listElement = document.getElementById('leaderboard-list');
if (listElement.innerHTML === '') {
listElement.innerHTML = `<li class="list-item glass-card" style="justify-content:center;"><div class="spinner"></div></li>`;
}
const leaderboardData = await postToAction('getLeaderboard'); 
if (!Array.isArray(leaderboardData) || leaderboardData.length === 0) {
listElement.innerHTML = '<li class="list-item glass-card" style="justify-content:center;">No one has scanned any ducks yet!</li>';
return;
}
let html = '';
leaderboardData.slice(0, 10).forEach((player, index) => {
const rank = index + 1;
const emoji = rank === 1 ? '🏆' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `${rank}.`;
const lastNameInitial = (player.lastName && player.lastName.length > 0) ? `${player.lastName.charAt(0)}.` : '';
const displayName = `${player.firstName} ${lastNameInitial}`;
html += `<li class="list-item glass-card"><div>${emoji}<div class="rank-text">${displayName}</div></div><span>${player.points} pts</span></li>`;
});
listElement.innerHTML = html;
}
function updateScanHistory() {
const listElement = document.getElementById('log-list');
const scanData = scanHistoryCache;
if (!scanData || scanData.length === 0) {
    if (scanHistoryCache.length === 0 && !document.querySelector('#log-list .spinner')) {
        listElement.innerHTML = '<li class="list-item glass-card" style="justify-content:center;"><div class="spinner"></div></li>';
    } else {
        listElement.innerHTML = '<li class="list-item glass-card" style="justify-content:center;">You haven\'t scanned any ducks yet.</li>';
    }
    return;
}
let html = '';
scanData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(scan => {
const scanDate = new Date(scan.timestamp);
const timeString = scanDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
const duckTypeDisplay = scan.duckType === 'Golden Duck' ? '🥇 Golden Duck' : scan.duckType || 'Duck';
html += `<li class="list-item glass-card"><div><div class="primary-text">${duckTypeDisplay}</div><div class="secondary-text">${scan.duckId} - ${timeString}</div></div><span>+${scan.points || 0}</span></li>`;
});
listElement.innerHTML = html;
}
// --- INFO PAGE FUNCTIONS ---
function showInfoModal(title, content) {
document.getElementById('modal-title').textContent = title || "Information Detail";
const contentEl = document.getElementById('modal-content');

let html = '';
if (typeof content === 'string') {
html = content.split('\n').map(p => `<p>${p}</p>`).join('');
} else if (Array.isArray(content)) {
html = '<ul>' + content.map(item => `<li>${item}</li>`).join('') + '</ul>';
} else {
html = "<p>No content available.</p>";
}
contentEl.innerHTML = html;

document.getElementById('info-modal-backdrop').style.display = 'flex';
document.body.style.overflow = 'hidden';
}

function renderInfoCards(infoItems) {
const container = document.getElementById('info-container');
if (!infoItems || infoItems.length === 0) {
container.innerHTML = "<h4 style='text-align:center; color:rgba(255,255,255,0.7);'>No information is available at this time.</h4>";
return;
}

let html = '';
infoItems.forEach((item, index) => {
html += `
<div class="info-card-button glass-card" data-info-index="${index}">
<h4>${item.title || 'Untitled'}</h4>
</div>
`;
});
container.innerHTML = html;

document.querySelectorAll('.info-card-button').forEach(button => {
button.addEventListener('click', (e) => {
const index = e.currentTarget.dataset.infoIndex;
const infoItem = infoDataCache[index];
if (infoItem) {
showInfoModal(infoItem.title, infoItem.content);
}
});
});
}

async function fetchAndRenderInfoData() {
const container = document.getElementById('info-container');
const fiveMinutes = 5 * 60 * 1000;

if (!infoDataCache || infoDataCache.length === 0) {
container.innerHTML = '<div class="spinner" style="margin-top: 2rem;"></div>';
}

if (infoDataCache.length > 0 && infoDataFetchTime && (new Date() - infoDataFetchTime < fiveMinutes)) {
renderInfoCards(infoDataCache);
return;
}

const result = await postToAction('getInfoData');
if (result.status === 'success') {
updateRibbon(result.ribbonText);
infoDataCache = result.infoItems || [];
infoDataFetchTime = new Date();
renderInfoCards(infoDataCache);
} else {
updateRibbon('');
container.innerHTML = "<h4 style='text-align:center; color:rgba(255,255,255,0.7);'>Could not load information. Please try again later.</h4>";
}
}
// --- UTILITY & NAVIGATION ---
function startScanner() {
    if (document.getElementById('hunt-page')?.classList.contains('active')) {
        html5QrCode = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: { width: 220, height: 220 }, aspectRatio: 1.0 };
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, () => {})
            .then(() => {
                const torchButton = document.getElementById('torch-toggle-btn');
                try {
                    const capabilities = html5QrCode.getRunningTrackCapabilities();
                    if (capabilities.torch) {
                        torchButton.classList.remove('hidden');
                    }
                } catch (e) {
                    console.warn("Could not check for torch capabilities:", e);
                }
            })
            .catch(err => {});
    }
}
function stopScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().catch(err => {});
    }
    const torchButton = document.getElementById('torch-toggle-btn');
    if (torchButton) {
        torchButton.classList.add('hidden');
        torchButton.classList.remove('torch-on');
    }
}
function logout() {
    sessionStorage.removeItem('currentUserStudentId');
    if (batchSendTimer) clearInterval(batchSendTimer);
    if (dataRefreshTimer) clearInterval(dataRefreshTimer);
    stopScanner();
    currentUser = null;
    location.reload();
}
function switchPage(pageId) {
stopScanner();
if (mapResizeObserver) {
mapResizeObserver.disconnect();
mapResizeObserver = null;
}
document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
document.getElementById(pageId)?.classList.add('active');
document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
document.querySelector(`.tab-button[data-page="${pageId}"]`)?.classList.add('active');

const appContainer = document.getElementById('app-container');
appContainer.scrollTop = 0;

if (pageId === 'hunt-page') {
updateUserDashboard(scanQueue.length === 0);
setTimeout(startScanner, 250);
} else if (pageId === 'leaderboard-page') {
updateLeaderboard();
} else if (pageId === 'log-page') {
updateScanHistory();
} else if (pageId === 'map-page') {
initializeMap(); 
} else if (pageId === 'info-page') {
fetchAndRenderInfoData();
}
}
function checkForInitialDuck() {
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('duckId')) {
initialDuckId = urlParams.get('duckId');
showNotification("Duck found! Sign in or register to claim it.");
}
}
function showNotification(message) {
const el = document.createElement('div');
el.className = 'glass-card';
el.style.position = 'fixed';
el.style.top = '-150px';
el.style.left = '50%';
el.style.transform = 'translateX(-50%)';
el.style.zIndex = '999';
el.style.width = '80%';
el.maxWidth = '350px';
el.innerHTML = `<p>${message}</p>`;
document.body.appendChild(el);
setTimeout(() => el.style.top = '20px', 10);
setTimeout(() => {
el.style.top = '-150px';
setTimeout(() => el.remove(), 500);
}, 3000);
}
// --- EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
startRandomFadingDuckFeet();
checkForInitialDuck();
const savedStudentId = sessionStorage.getItem('currentUserStudentId');
if (savedStudentId) {
signIn(savedStudentId);
}
document.getElementById('signin-btn').addEventListener('click', () => {
const studentId = document.getElementById('login-studentid').value.trim();
if (studentId) signIn(studentId);
});
document.getElementById('submit-btn').addEventListener('click', registerUser);
document.getElementById('register-btn').addEventListener('click', () => {
loginView.classList.add('hidden');
registrationView.classList.remove('hidden');
});
document.getElementById('back-btn').addEventListener('click', () => {
registrationView.classList.add('hidden');
loginView.classList.remove('hidden');
});
document.getElementById('close-instructions').addEventListener('click', () => {
document.getElementById('instructions-card').style.display = 'none';
});
document.getElementById('tab-bar').addEventListener('click', (e) => {
if (e.target.matches('.tab-button')) {
switchPage(e.target.dataset.page);
}
});
document.getElementById('scan-history-link').addEventListener('click', (e) => {
e.preventDefault();
switchPage(e.target.dataset.page);
});
document.getElementById('logout-btn').addEventListener('click', logout);
document.getElementById('torch-toggle-btn').addEventListener('click', () => {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.toggleTorch()
            .then(() => {
                document.getElementById('torch-toggle-btn').classList.toggle('torch-on');
            })
            .catch(err => console.error("Error toggling torch:", err));
    }
});
const modalBackdrop = document.getElementById('info-modal-backdrop');
if (modalBackdrop) {
document.getElementById('modal-close-btn').addEventListener('click', () => {
modalBackdrop.style.display = 'none';
document.body.style.overflow = 'hidden';
});
modalBackdrop.addEventListener('click', (e) => {
if (e.target.id === 'info-modal-backdrop') {
modalBackdrop.style.display = 'none';
document.body.style.overflow = 'hidden';
}
}
);
}
});
</script>
</body>
</html>
