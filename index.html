<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Duck Hunt 2025</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
/* ----------------------------------------------------------------- */
/* ğŸ GLASS GLOW UI (Merged Styles) */
/* ----------------------------------------------------------------- */
:root {
--green: #60A34D;
--pink: #ff69b4;

/* ğŸŒŸ GLASS VARIABLES ğŸŒŸ */
--glass-bg: rgba(255, 255, 255, 0.1); /* Lighter base for frosted look */
--glass-border: rgba(255, 255, 255, 0.3); /* High-contrast white border */
--glass-shadow: rgba(0, 0, 0, 0.5); /* Stronger shadow for lift */
--glow-color: rgba(96, 163, 77, 0.8); /* Adjusted glow color opacity */

/* Map/Old Vars mapped to New UI colors */
--card-bg: var(--glass-bg); 
--border-color: var(--glass-border); 
--frosted-black: rgba(0, 0, 0, 0.85);

--tab-bar-height: 65px;
--safe-padding: 1rem;
--ribbon-height: 40px;
--gold: #FFD700;
}
body {
margin: 0;
background-color: #0d1216; /* Dark background for glow/glass contrast */
overflow-x: auto;
min-height: 100vh;
min-height: 100svh;
font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
color: white;
text-align: center;
}
.hidden { display: none !important; }
/* Spinner styles */
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.button-group button .spinner { width: 18px; height: 18px; border-width: 3px; }

/* ğŸŒŸ CORE GLASS EFFECT ğŸŒŸ */
.glass-card { 
    position: relative;
    background: var(--glass-bg); 
    backdrop-filter: blur(15px); 
    -webkit-backdrop-filter: blur(15px); 
    border: 1px solid var(--glass-border); 
    border-radius: 20px; 
    box-shadow: 0 8px 32px 0 var(--glass-shadow); 
    padding: 1.5rem; 
    transition: all 0.3s ease;
}

/* ğŸŒŸ GREEN GLOW ON HOVER ğŸŒŸ */
.glass-card:hover {
    border-color: var(--green);
    box-shadow: 0 0 15px var(--glow-color);
}

.transparent-heading-box { background: none; border: none; border-radius: 10px; padding: 0.75rem 0; margin: 0 auto 1.5rem auto; width: 100%; max-width: 450px; box-sizing: border-box; text-align: center; }
#app-wrapper {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
display: flex;
flex-direction: column;
padding-top: var(--ribbon-height);
transition: padding-top 0.3s ease;
}
#app-wrapper.ribbon-active {
padding-top: var(--ribbon-height);
}
#ribbon-message {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: var(--ribbon-height);
background-color: var(--frosted-black);
backdrop-filter: blur(8px);
-webkit-backdrop-filter: blur(8px);
border-bottom: 1px solid rgba(255, 255, 255, 0.2);
font-weight: bold;
font-size: 0.85rem;
display: flex;
align-items: center;
overflow: hidden;
z-index: 1000;
box-sizing: border-box;
transition: transform 0.3s ease-out;
transform: translateY(-100%);
}
#ribbon-message.visible {
transform: translateY(0);
}
#ribbon-content {
white-space: nowrap;
display: flex;
align-items: center;
will-change: transform;
color: var(--gold);
height: 100%;
}
#ribbon-content span {
color: white;
font-weight: normal;
padding-left: 8px;
}
.marquee-start {
animation-name: marquee-scroll;
animation-timing-function: linear;
animation-iteration-count: infinite;
}
@keyframes marquee-scroll {
from { transform: translateX(0); }
to { transform: translateX(var(--marquee-distance)); }
}
#app-container {
flex: 1;
overflow-y: auto;
height: calc(100svh - var(--tab-bar-height) - var(--ribbon-height));
padding-bottom: calc(var(--safe-padding) + var(--tab-bar-height));
}
.app-page {
width: 100%;
min-height: 100%;
box-sizing: border-box;
padding: 0 var(--safe-padding);
display: none;
flex-direction: column;
gap: 0;
align-items: center;
}
.app-page.active { display: flex; }
.app-page h2 { margin: 0; flex-shrink: 0; text-align: center; }
.app-page .header-image-top {
width: 70%;
max-width: 250px;
margin: 0.2rem auto 0.2rem auto;
display: block;
flex-shrink: 0;
}
#hunt-page { justify-content: flex-start; padding-top: 0; }
#info-page, #map-page, #leaderboard-page, #log-page { justify-content: flex-start; padding-top: 0; }
#hunt-content-wrapper {
position: relative;
width: 100%;
max-width: 350px;
display: flex;
flex-direction: column;
gap: 0.75rem;
align-items: center;
margin-top: 0;
flex-shrink: 0;
}
#qr-reader-container { padding: 0; display: flex; position: relative; width: 100%; aspect-ratio: 1 / 1; border: 2px solid var(--border-color); box-shadow: 0 0 10px rgba(0,0,0,0.5); max-width: 300px; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
#qr-reader { width: 100%; height: 100%; border-radius: 20px; overflow: hidden; }
#qr-reader-container.error-flash { animation: flash-red 0.5s ease; }
@keyframes flash-red { 0%, 100% { box-shadow: 0 0 10px rgba(0,0,0,0.5); border-color: var(--border-color); } 50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.9); border-color: rgba(255, 0, 0, 0.9); } }
.point-pop {
position: absolute;
top: 85%;
left: 50%;
transform: translate(-50%, -50%);
font-size: 1.5rem;
font-weight: 800;
color: #FFFFFF;
background: rgba(0, 0, 0, 0.7);
border: 2px solid #FFFFFF;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
padding: 0.5rem 1.5rem;
border-radius: 5px;
min-width: 250px;
text-shadow: 0 0 5px rgba(255,255,255,0.5);
animation: float-up-short 3s ease-out forwards;
pointer-events: none;
}
@keyframes float-up-short { 0% { top: 85%; opacity: 1; } 50% { top: 70%; opacity: 1; } 100% { top: 70%; opacity: 0; } }
#golden-flash-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: var(--gold);
z-index: 1001;
opacity: 0;
pointer-events: none;
}
@keyframes gold-flash {
0% { opacity: 0; }
10% { opacity: 0.9; }
50% { opacity: 0.4; }
100% { opacity: 0; }
}
.golden-point-pop {
border-color: var(--gold) !important;
color: var(--gold) !important;
background: rgba(10, 10, 10, 0.9) !important;
box-shadow: 0 0 15px var(--gold), 0 0 5px rgba(255, 215, 0, 0.5) !important;
text-shadow: 0 0 8px #fff !important;
font-size: 1.8rem !important;
}
.footer-logo {
height: 50px;
margin: 0 auto 5px auto;
display: block;
object-fit: contain;
}
#scanner-footer-details {
display: flex;
flex-direction: column;
align-items: center;
gap: 0.75rem;
margin-top: 0.5rem;
flex-shrink: 0;
}
#scan-history-link {
font-size: 1.1rem;
color: var(--green);
text-decoration: underline;
cursor: pointer;
margin-top: 0;
font-weight: bold;
}
#player-rank-display { margin-top: 0; font-size: 1.1rem; font-weight: 600; }

/* ----------------------------------------------------------------- */
/* ğŸ—ºï¸ MAP SPECIFIC STYLES (EXACTLY AS REQUESTED) ğŸ—ºï¸ */
/* ----------------------------------------------------------------- */
#map-page {
Â  Â  /* New: Allows map card to scroll vertically relative to the page */
Â  Â  padding-top: var(--safe-padding);Â 
Â  Â  justify-content: flex-start;
}

#map-card-container {
Â  Â  /* Card container properties */
Â  Â  flex: 1;Â 
Â  Â  width: 100%;
Â  Â  max-width: 450px;Â 
Â  Â Â 
Â  Â  /* CRITICAL: Set a fixed height and enable internal scrolling */
Â  Â  height: 60vh; /* Adjust height as needed for mobile screen visibility */
Â  Â  padding: 0;Â 
Â  Â  overflow-x: scroll; /* Enables horizontal scrolling within this card */
Â  Â  overflow-y: hidden; /* Disables vertical scrolling if map is wider than tall */
}

#map-wrapper {
Â  Â  /* We still need a very large width to allow the image to scale beyond the screen */
Â  Â  width: 250vw;Â 
Â  Â  max-width: none;Â 
Â  Â Â 
Â  Â  /* CRITICAL: Make wrapper match the height of #map-card-container */
Â  Â  height: 100%;Â 
Â  Â Â 
Â  Â  position: relative;
Â  Â  margin: 0;Â 
Â  Â  line-height: 0;
}
#campus-map-img {
Â  Â  width: 100%;
Â  Â  /* CRITICAL: Allow image to scale its height proportionally based on the 100% width,Â 
Â  Â  Â  Â but clip the bottom if it exceeds the 60vh height of the card. */
Â  Â  height: 100%;Â 
Â  Â  object-fit: contain; /* Ensures the whole image is visible within the 100% height/width */
Â  Â  object-position: center;
Â  Â  border-radius: 10px;
Â  Â  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
Â  Â  display: block;
Â  Â  user-select: none;
Â  Â  -webkit-user-drag: none;
}
#map-markers-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none; /* Allows clicks to pass through to markers */
}

/* --- MAP LABEL STYLES --- */
.map-label {
position: absolute;
z-index: 10;
transform: translate(-50%, -50%); /* Center based on position */
cursor: default;Â 
pointer-events: auto; /* Ensure the box is interactable/visible */

/* Merged Frosted Card Look */
background: var(--frosted-black);
backdrop-filter: blur(8px);
-webkit-backdrop-filter: blur(8px);
border: 1px solid var(--green);
border-radius: 8px;
/* SIZING WITH VW UNITS for dynamic scaling on mobile zoom */
padding: 0.7vw 1.2vw;Â 
min-width: 15vw;Â 
text-align: center;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
white-space: normal;
line-height: 1.3;
}
/* Applying glow for consistency */
.map-label:hover {
    box-shadow: 0 0 15px var(--glow-color);
}

.map-label h4 {
margin: 0;
font-size: 2.2vw; /* DYNAMIC FONT SIZE */
font-weight: bold;
color: white; /* Ensure text is visible */
}
.map-label p {
margin: 0;
padding-top: 0.3vw; /* DYNAMIC SPACING */
font-size: 1.8vw; /* DYNAMIC FONT SIZE */
color: rgba(255, 255, 255, 0.9);
}

.map-label.cleared {
border-color: #ff4d4d;
background-color: rgba(50, 50, 50, 0.85);
opacity: 0.8;
}

/* End Map Specific Styles */
/* ----------------------------------------------------------------- */
/* ğŸ¨ UI ELEMENTS - MERGED WITH GLASS GLOW STYLING */
/* ----------------------------------------------------------------- */
#log-container, #leaderboard-container, #info-container {
flex: 1;
overflow-y: auto;
min-height: 0;
padding: var(--safe-padding) 0;
position: relative;
background: none;
border-radius: 0;
box-shadow: none;
border: none;
gap: 0.5rem;
display: flex;
flex-direction: column;
width: 100%;
max-width: 450px;
}
#info-container {
text-align: center;
display: flex;
flex-direction: column;
gap: 0.5rem;
width: 100%;
max-width: 450px;
margin: 0 auto;
}
#info-modal-backdrop {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.8);
backdrop-filter: blur(5px);
z-index: 200;
display: none;
align-items: center;
justify-content: center;
}
#info-modal {
position: relative;
width: 90%;
max-width: 400px;
background: var(--frosted-black);
backdrop-filter: blur(10px);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 20px;
padding: 1.5rem;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
max-height: 80vh;
overflow-y: auto;
text-align: left;
}
#modal-close-btn {
position: absolute;
top: 10px;
right: 10px;
background: none;
border: none;
color: white;
font-size: 2rem;
cursor: pointer;
}
#modal-title {
margin-top: 0;
border-bottom: 2px solid var(--green);
padding-bottom: 0.5rem;
}
#modal-content {
text-align: left;
padding: 0 0.5rem;
}
#modal-content ul {
list-style-type: disc;
padding-left: 25px;
}
#modal-content li {
margin-bottom: 0.5rem;
}
.info-card-button {
background: var(--glass-bg); /* Using glass style */
border: 1px solid var(--glass-border);
border-radius: 12px;
padding: 1rem 1.5rem;
width: 100%;
text-align: center;
cursor: pointer;
transition: background-color 0.3s ease, box-shadow 0.3s ease;
margin-bottom: 0.75rem;
box-sizing: border-box;
}
.info-card-button:hover {
background-color: rgba(96, 163, 77, 0.3);
box-shadow: 0 0 10px var(--glow-color);
}
.info-card-button h4 {
margin: 0;
font-size: 1.2rem;
font-weight: bold;
color: white;
}
.location-card { background: var(--card-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid var(--border-color); border-radius: 12px; padding: 0.8rem 1.2rem; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2); display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
.location-details { display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; }
.location-details h4 { margin: 0; font-size: 1rem; font-weight: bold; }
.location-details span { font-size: 1rem; color: white; font-weight: bold; margin-top: 0.25rem; }
#leaderboard-list, #log-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.5rem; }
.list-item {
display: flex;
align-items: center;
justify-content: space-between;
padding: 1rem;
background: var(--card-bg);
backdrop-filter: blur(8px);
-webkit-backdrop-filter: blur(8px);
border-radius: 8px;
border: 1px solid var(--border-color);
box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
}
#leaderboard-list .list-item {
background: var(--card-bg);
border: 1px solid var(--border-color);
box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
}
.list-item:hover {
    border-color: var(--green);
    box-shadow: 0 0 10px var(--glow-color);
}
#leaderboard-list .list-item > div:first-child { display: flex; align-items: center; }
.list-item .rank-text {
font-weight: bold;
font-size: 1.2rem;
margin-left: 0.5rem;
white-space: nowrap;
}
#leaderboard-list .list-item span {
font-weight: bold;
font-size: 1.3rem;
color: var(--green);
}
#log-list .list-item > div:first-child { display: flex; flex-direction: column; align-items: flex-start; }
#log-list .list-item .primary-text { font-weight: bold; font-size: 1.1rem; margin-bottom: 0; }
#log-list .list-item .secondary-text { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 0.2rem; }
.button-group { display: flex; gap: 0.5rem; }
.button-group button, .full-width-btn { flex: 1; border-radius: 10px; padding: 12px 15px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border: 2px solid var(--green); transition: all 0.3s ease; box-shadow: 0 0 0 rgba(96, 163, 77, 0); min-height: 48px; box-sizing: border-box; display: flex; justify-content: center; align-items: center; }
.primary-btn { background-color: var(--green); color: white; }
.secondary-btn { background-color: transparent; color: var(--green); }
.primary-btn:hover, .secondary-btn:hover, .full-width-btn:hover { box-shadow: 0 0 10px var(--glow-color); }
#lava-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: -1;
}
#lava-container::before, #lava-container::after { content: ''; position: absolute; width: 70vmax; height: 70vmax; border-radius: 50%; opacity: 0.8; mix-blend-mode: lighten; filter: blur(120px); }
#lava-container::before { background-color: var(--pink); top: -35vmax; left: -35vmax; animation: move-pink 25s infinite linear; }
#lava-container::after { background-color: var(--green); bottom: -35vmax; right: -35vmax; animation: move-green 20s infinite linear; animation-delay: -10s; }
.screen { opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
.screen.visible { opacity: 1; pointer-events: auto; }
#login-screen { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.reg-input:hover, #login-studentid:hover { border-color: var(--green); box-shadow: 0 0 10px var(--glow-color); }
.reg-input:focus, #login-studentid:focus { outline: none; border-color: var(--green); box-shadow: 0 0 10px var(--glow-color); }
#instructions-card { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); padding: 0.8rem 1.2rem; border-radius: 12px; width: 90%; max-width: 450px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; z-index: 101; background: var(--card-bg); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
#header-card { position: relative; width: 85%; max-width: 300px; margin-bottom: 1.5rem; }
#login-view, #registration-view { display: flex; flex-direction: column; gap: 1.5rem; }
.input-group { display: flex; flex-direction: column; gap: 1rem; }
.reg-input, #login-studentid { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 12px 15px; font-size: 1rem; color: white; text-align: center; transition: box-shadow 0.3s ease, border-color 0.3s ease; }
footer {
position: absolute;
bottom: 0;
left: 0;
right: 0;
padding: 10px 10px 20px 10px;
color: rgba(255, 255, 255, 0.7);
font-size: 0.8rem;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}
.footer-logo {
height: 50px;
margin: 0 auto 5px auto;
display: block;
object-fit: contain;
}
footer p { margin: 2px 0; }
#scanner-overlay-stats { position: absolute; top: 0; left: 0; right: 0; z-index: 10; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-radius: 20px 20px 0 0; padding: 0.8rem; display: flex; justify-content: space-around; }
.stat { text-align: center; }
.stat h4 { margin: 0; color: rgba(255,255,255,0.7); font-weight: bold; font-size: 0.9rem; }
.stat p { margin: 0; font-size: 1.2rem; font-weight: bold; }
#tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--tab-bar-height); z-index: 150; background: rgba(10, 10, 10, 0.5); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
.tab-button { background: none; border: none; color: rgba(255,255,255,0.6); font-size: 0.9rem; cursor: pointer; flex-grow: 1; font-weight: 600; }
.tab-button.active { color: var(--green); font-weight: bold; }
.duck-animation { position: absolute; top: 50%; left: -50px; font-size: 50px; animation: fly-across 2s linear forwards; pointer-events: none; z-index: 1000; }
.frost-animation { position: absolute; top: -20px; font-size: 1.5rem; color: white; pointer-events: none; z-index: 999; animation: fall-and-fade linear forwards; }
@keyframes fly-across { 0% { transform: translateX(0) translateY(0) rotate(0deg); } 25% { transform: translateX(25vw) translateY(-40px) rotate(15deg); } 50% { transform: translateX(50vw) translateY(0) rotate(0deg); } 75% { transform: translateX(75vw) translateY(-40px) rotate(-15deg); } 100% { transform: translateX(110vw) translateY(0) rotate(0deg); } }
@keyframes fall-and-fade { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
@keyframes move-pink { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(calc(100vw - 70vmax), 0); } 50% { transform: translate(calc(100vw - 70vmax), calc(100vh - 70vmax)); } 75% { transform: translate(0, calc(100vh - 70vmax)); } }
@keyframes move-green { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(calc(-100vw + 70vmax), 0); } 50% { transform: translate(calc(-100vw + 70vmax), calc(-100vh + 70vmax)); } 75% { transform: translate(0, calc(-100vh + 70vmax)); } }
#duck-feet-background-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: 0;
pointer-events: none;
overflow: hidden;
}
.fading-duck-feet {
position: absolute;
width: 50px;
height: 50px;
background-image: url('https://i.imgur.com/S23b6Wc.png');
background-size: contain;
background-repeat: no-repeat;
opacity: 0;
animation: fade-in-out linear forwards;
pointer-events: none;
}
@keyframes fade-in-out {
0% { opacity: 0; transform: scale(0.8); }
20% { opacity: 0.6; transform: scale(1); }
80% { opacity: 0.6; transform: scale(1); }
100% { opacity: 0; transform: scale(1.2); }
}
</style>
</head>
<body>
<div id="golden-flash-overlay" class="hidden"></div>
<div id="ribbon-message">
<div id="ribbon-content"></div>
</div>
<div id="lava-container"></div>
<div id="duck-feet-background-container"></div>
<div id="login-screen" class="screen visible">
<div class="glass-card" id="instructions-card">
<p>Tap <img src="https://i.imgur.com/wFrSvUH.png" alt="Share Icon" style="height:1.2em; vertical-align:middle; margin: 0 0.2em;"> to Add to Home Screen!</p>
<button id="close-instructions" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
</div>
<div class="glass-card" id="header-card">
<div id="login-view">
<img class="header-image" style="width:100%;" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<input type="text" id="login-studentid" class="reg-input" placeholder="Student ID">
<div class="button-group">
<button id="signin-btn" class="secondary-btn">Sign In</button>
<button id="register-btn" class="primary-btn">Register</button>
</div>
</div>
<div id="registration-view" class="hidden">
<h3 style="text-align: center;">Welcome To The Hunt!</h3>
<div class="input-group">
<input type="text" id="reg-firstname" class="reg-input" placeholder="First Name"><input type="text" id="reg-lastname" class="reg-input" placeholder="Last Name">
<input type="text" id="reg-studentid" class="reg-input" placeholder="Student ID"><input type="email" id="reg-email" class="reg-input" placeholder="Email @my.gcu.edu">
</div>
<div class="button-group">
<button id="back-btn" class="secondary-btn">Back</button><button id="submit-btn" class="primary-btn">Submit</button>
</div>
</div>
</div>
<footer>
<img src="https://i.imgur.com/p2qZOL5.png" alt="Canyon Activities Board Logo" class="footer-logo">
<p>Follow Us At <b>@CABGCU</b> On Instagram</p>
<p>Hosted by the Canyon Activities Board at Grand Canyon University</p>
</footer>
</div>
<div id="app-wrapper" class="screen">
<main id="app-container">
<section id="hunt-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<div id="hunt-content-wrapper">
<h2 class="transparent-heading-box" id="welcome-message"></h2>
<div id="qr-reader-container" class="glass-card">
<div id="scanner-overlay-stats">
<div class="stat"><h4>POINTS</h4><p id="player-points">0</p></div>
<div class="stat"><h4>DUCKS</h4><p id="player-ducks">0</p></div>
</div>
<div id="qr-reader"></div>
</div>
<div id="scanner-footer-details">
<a id="scan-history-link" href="#" data-page="log-page">Scan History</a>
<div id="player-rank-display"></div>
</div>
</div>
</section>

<section id="map-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<div id="map-card-container" class="glass-card">
Â  Â  <div id="map-wrapper">
Â  Â  Â  Â  <img id="campus-map-img"
Â  Â  Â  Â  src="https://i.imgur.com/1aQCsPk.jpeg"
Â  Â  Â  Â  alt="Interactive Campus Map">
Â  Â  Â  Â  <div id="map-markers-overlay"></div>
Â  Â  </div>
</div>
</section>

<section id="leaderboard-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<h2 class="transparent-heading-box">Leaderboard</h2>
<div id="leaderboard-container"><ul id="leaderboard-list"></ul></div>
</section>
<section id="log-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<h2 class="transparent-heading-box">Scan History</h2>
<div id="log-container"><ul id="log-list"></ul></div>
</section>
<section id="info-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<h2 class="transparent-heading-box">Information</h2>
<div id="info-container">
</div>
</section>
</main>
<nav id="tab-bar">
<button class="tab-button" data-page="hunt-page">Scanner</button>
<button class="tab-button" data-page="leaderboard-page">Leaderboard</button>
<button class="tab-button" data-page="map-page">Map</button>
<button class="tab-button" data-page="info-page">Info</button>
</nav>
</div>
<div id="info-modal-backdrop" style="display: none;">
<div id="info-modal">
<button id="modal-close-btn">&times;</button>
<h3 id="modal-title"></h3>
<div id="modal-content"></div>
</div>
</div>
<script>
// --- CONFIGURATION ---
// UPDATED SCRIPT URL
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyzgyRQZe5Y2A3W8YkVRwCPv7OAseEHpSDcBzUjy-EEAn9kXc2TWMOi4UtTTUz4PROD/exec';
const POPUP_DURATION_MS = 2000;
const BATCH_SEND_INTERVAL_MS = 15000;
const DATA_REFRESH_INTERVAL_MS = 60000; // 60 seconds for server correction
const VIRTUAL_LIMIT = 10; // Explicitly define the limit
const VIRTUAL_LOCATIONS = ['Commuter Lounge', 'Thunderground', 'Riverbed'];

/*
|=================================================================================|
| **MAP COORDINATE SETUP (EXACTLY AS PROVIDED IN YOUR SOURCE)**
|=================================================================================|
*/
const MAP_SPOTS = [
{ name: 'The Grove', dataKey: 'The Grove', coords: '1295,758,1311,774' },
{ name: 'Lopes Way', dataKey: 'Lopes Way', coords: '2270,1911,2286,1927' },Â 
{ name: 'Main Campus', dataKey: 'Main Campus', coords: '1763,2398,1779,2414' },
{ name: 'North Campus', dataKey: 'North Campus', coords: '2738,1116,2754,1132' },
{ name: 'East Campus', dataKey: 'East Campus', coords: '3882,2468,3898,2484' },
{ name: 'The Rivers', dataKey: 'The Rivers', coords: '4757,1136,4773,1152' },
{ name: 'Riverbed Virtual', dataKey: 'Riverbed', coords: '5125,817,5141,833' },Â 
{ name: 'Commuter Lounge Virtual', dataKey: 'Commuter Lounge', coords: '1355,1900,1371,1916' },Â 
{ name: 'Thunderground Virtual', dataKey: 'Thunderground', coords: '1514,1680,1530,1696' },
];

// --- GLOBAL STATE & DOM REFERENCES ---
let html5QrCode = null;
let currentUser = null;
let initialDuckId = null;
let infoDataCache = [];
let infoDataFetchTime = null;
let mapResizeObserver = null;
const loginScreen = document.getElementById('login-screen');
const appWrapper = document.getElementById('app-wrapper');
const loginView = document.getElementById('login-view');
const registrationView = document.getElementById('registration-view');
const ribbonMessage = document.getElementById('ribbon-message');
const mapImageElement = document.getElementById('campus-map-img');

// --- CACHING & STATE ---
let duckDataCache = {};
let claimedDucksCache = new Set();
let processingDucks = new Set(); 
let localVirtualScanTimestamps = [];
let scanHistoryCache = [];
let scanQueue = [];
let batchSendTimer = null;
let dataRefreshTimer = null;
let locationCountsCache = {};Â 

// --- MAP INTERACTION LOGIC ---
const mapWrapper = document.getElementById('map-wrapper');

function positionMarkers() {
const overlay = document.getElementById('map-markers-overlay');
if (!overlay || !mapImageElement || mapImageElement.naturalWidth === 0) return;

overlay.innerHTML = '';Â 
const locationData = locationCountsCache;Â 

MAP_SPOTS.forEach(spot => {
const marker = document.createElement('div');
marker.className = 'map-label';Â 

const [x1, y1, x2, y2] = spot.coords.split(',').map(Number);
const centerX = (x1 + x2) / 2;
const centerY = (y1 + y2) / 2;

marker.style.left = `${(centerX / mapImageElement.naturalWidth) * 100}%`;
marker.style.top = `${(centerY / mapImageElement.naturalHeight) * 100}%`;

const dataKey = spot.dataKey;Â 
const displayName = spot.name;Â 

let remainingText;
let spotData = locationData[dataKey];Â 

if (!spotData) {
remainingText = '<strong>N/A</strong> Codes Left';
marker.style.borderColor = 'gray';Â 
} else {
const remaining = spotData.count;
if (remaining > 0) {
remainingText = `ğŸ¦† <strong>${remaining}</strong> Codes Left`;
marker.style.borderColor = 'var(--green)';
} else {
remainingText = `âŒ <strong>CLEARED</strong>`;
marker.classList.add('cleared');
}
}

marker.innerHTML = `<h4>${displayName}</h4><p>${remainingText}</p>`;
overlay.appendChild(marker);
});
}

async function updateDuckMapData() {
Â  Â  const result = await postToAction('getDuckCounts');

Â  Â  if (result.status === 'success' && result.locations) {
Â  Â  Â  Â  locationCountsCache = {};
Â  Â  Â  Â  Object.keys(result.locations).forEach(name => {
Â  Â  Â  Â  Â  Â  locationCountsCache[name] = { count: result.locations[name] };
Â  Â  Â  Â  });
Â  Â  }
}

function initializeMap() {
Â  Â  if (mapResizeObserver) {
Â  Â  Â  Â  mapResizeObserver.disconnect();
Â  Â  Â  Â  mapResizeObserver = null;
Â  Â  }

Â  Â  const imageLoadPromise = new Promise(resolve => {
Â  Â  Â  Â  if (mapImageElement.complete && mapImageElement.naturalWidth > 0) {
Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  mapImageElement.onload = null;
Â  Â  Â  Â  Â  Â  mapImageElement.onerror = null;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  mapImageElement.onload = resolve;
Â  Â  Â  Â  Â  Â  mapImageElement.onerror = resolve;Â 
Â  Â  Â  Â  }
Â  Â  });

Â  Â  Promise.all([imageLoadPromise, updateDuckMapData()]).then(() => {
Â  Â  Â  Â  if (mapImageElement.naturalWidth > 0) {
Â  Â  Â  Â  Â  Â  positionMarkers();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!mapResizeObserver) {
Â  Â  Â  Â  Â  Â  Â  Â  mapResizeObserver = new ResizeObserver(positionMarkers);
Â  Â  Â  Â  Â  Â  Â  Â  mapResizeObserver.observe(mapImageElement);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error("Map image failed to load or has zero dimensions.");
Â  Â  Â  Â  }
Â  Â  });
}
// --- END MAP INTERACTION LOGIC ---

// --- FETCH HELPER ---
async function postToAction(action, payload = {}) {
try {
const response = await fetch(SCRIPT_URL, {
method: 'POST',
body: JSON.stringify({ action, ...payload })
});
if (!response.ok) {
throw new Error(`Network response was not ok: ${response.statusText}`);
}
return await response.json();
} catch (error) {
console.error(`Fetch error for action "${action}":`, error);
return { status: "error", message: "Network error or script failure." };
}
}
// --- RIBBON DISPLAY FUNCTION ---
function updateRibbon(ribbonText) {
const ribbonContent = document.getElementById('ribbon-content');
const scrollSpeed = 25;
ribbonContent.style.animation = 'none';
ribbonContent.style.transform = 'translateX(0)';
ribbonContent.style.paddingLeft = '100%';
if (ribbonText && ribbonText.trim() !== '') {
ribbonContent.innerHTML = `ğŸ“¢<span>${ribbonText}</span>`;
ribbonMessage.classList.add('visible');
appWrapper.classList.add('ribbon-active');
setTimeout(() => {
const contentWidth = ribbonContent.scrollWidth;
const viewWidth = ribbonMessage.clientWidth;
if (contentWidth > viewWidth) {
const totalDistance = contentWidth;
const duration = totalDistance / scrollSpeed;
ribbonContent.style.setProperty('--marquee-distance', `-${totalDistance}px`);
ribbonContent.style.animation = `marquee-scroll ${duration}s linear infinite`;
ribbonContent.style.paddingLeft = `${viewWidth}px`;
ribbonContent.style.textAlign = 'left';
} else {
ribbonContent.style.paddingLeft = '0';
ribbonContent.style.textAlign = 'center';
const centeredPadding = (viewWidth - ribbonContent.offsetWidth) / 2;
ribbonContent.style.paddingLeft = `${Math.max(0, centeredPadding)}px`;
ribbonContent.style.transform = 'translateX(0)';
ribbonContent.style.animation = 'none';
}
}, 10);
} else {
ribbonContent.innerHTML = '';
ribbonMessage.classList.remove('visible');
appWrapper.classList.remove('ribbon-active');
ribbonContent.style.animation = 'none';
}
}
// --- ANIMATION FUNCTIONS ---
function startRandomFadingDuckFeet() {
const container = document.getElementById('duck-feet-background-container');
const maxFeetOnScreen = 7;
const minDelay = 1000;
const maxDelay = 3000;
const animationDuration = 6000;
function createFadingFeet() {
const currentFeet = container.querySelectorAll('.fading-duck-feet');
if (currentFeet.length >= maxFeetOnScreen) {
currentFeet[0].remove();
}
const feet = document.createElement('div');
feet.className = 'fading-duck-feet';
const randomX = Math.random() * (window.innerWidth - 60);
const randomY = Math.random() * (window.innerHeight - 60);
feet.style.left = `${randomX}px`;
feet.style.top = `${randomY}px`;
const randomScale = 0.7 + Math.random() * 0.6;
feet.style.transform = `scale(${randomScale}) rotate(${Math.random() * 360}deg)`;
feet.style.animationDuration = `${animationDuration}ms`;
container.appendChild(feet);
setTimeout(() => {
feet.remove();
}, animationDuration);
const nextDelay = Math.random() * (maxDelay - minDelay) + minDelay;
setTimeout(createFadingFeet, nextDelay);
}
createFadingFeet();
}
function triggerDuckAnimation() {
const duckCount = Math.floor(Math.random() * 5) + 3;
for (let i = 0; i < duckCount; i++) {
setTimeout(() => {
const duck = document.createElement('div');
duck.textContent = 'ğŸ¦†';
duck.className = 'duck-animation';
duck.style.top = `${30 + Math.random() * 40}%`;
duck.style.animationDuration = `${1.5 + Math.random()}s`;
document.body.appendChild(duck);
setTimeout(() => duck.remove(), 2500);
}, i * 150);
}
}
function triggerGoldenDuckAnimation() {
const flash = document.getElementById('golden-flash-overlay');
flash.classList.remove('hidden');
flash.style.animation = 'gold-flash 0.8s ease-out forwards';
const emojis = ['ğŸ¦†', 'ğŸ¥‡', 'ğŸ’°', 'âœ¨'];
const count = 10;
for (let i = 0; i < count; i++) {
setTimeout(() => {
const item = document.createElement('div');
item.textContent = emojis[Math.floor(Math.random() * emojis.length)];
item.className = 'frost-animation';
item.style.fontSize = `${1.5 + Math.random() * 2.5}rem`;
item.style.color = '#FFD700';
item.style.left = `${Math.random() * 100}vw`;
item.style.animationDuration = `${1.5 + Math.random() * 2.5}s`;
item.style.animationDelay = `${Math.random() * 0.5}s`;
document.body.appendChild(item);
setTimeout(() => item.remove(), 5000);
}, 150 + i * 50);
}
setTimeout(() => {
flash.classList.add('hidden');
flash.style.animation = 'none';
}, 850);
}
function triggerFrostAnimation() {
const flakeCount = 15;
for (let i = 0; i < flakeCount; i++) {
const flake = document.createElement('div');
flake.textContent = 'â„ï¸';
flake.className = 'frost-animation';
flake.style.left = `${Math.random() * 100}vw`;
flake.style.animationDuration = `${2 + Math.random() * 3}s`;
flake.style.animationDelay = `${Math.random()}s`;
document.body.appendChild(flake);
setTimeout(() => flake.remove(), 5000);
}
}
// --- CORE SCANNING & SYNC LOGIC ---
async function onScanSuccess(decodedText) {
Â  Â  if (!currentUser) return;
Â  Â Â 
Â  Â  // Helper to trigger the visual error ring
Â  Â  const triggerVisualError = () => {
Â  Â  Â  Â  const qrContainer = document.getElementById('qr-reader-container');
Â  Â  Â  Â  qrContainer.classList.add('error-flash');
Â  Â  Â  Â  setTimeout(() => qrContainer.classList.remove('error-flash'), 500);
Â  Â  };

Â  Â  let finalDuckId = decodedText;
Â  Â  try {
Â  Â  Â  Â  const url = new URL(decodedText);
Â  Â  Â  Â  if (url.searchParams.has('duckId')) { finalDuckId = url.searchParams.get('duckId'); }
Â  Â  } catch (e) {}
Â  Â  const lookupId = finalDuckId.trim().toLowerCase();

Â  Â  // 1. Check if already permanently claimed
Â  Â  if (claimedDucksCache.has(lookupId)) {
Â  Â  Â  Â  triggerVisualError();Â 
Â  Â  Â  Â  return; // No message pop-up on duplicate claim
Â  Â  }
Â  Â Â 
Â  Â  // 2. Check if currently being processed (local lock)
Â  Â  if (processingDucks.has(lookupId)) {
Â  Â  Â  Â  triggerVisualError();Â 
Â  Â  Â  Â  return; // No message pop-up on scanning too fast
Â  Â  }
Â  Â Â 
Â  Â  const duckInfo = duckDataCache[lookupId];
Â  Â  if (!duckInfo) {
Â  Â  Â  Â  // FIX: Use the visual error ring for invalid codes, no message pop-up.
Â  Â  Â  Â  triggerVisualError();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // --- LOCK THE DUCK ID NOW ---
Â  Â  processingDucks.add(lookupId);Â 
Â  Â Â 
Â  Â  // --- Virtual Duck Limit Check ---
Â  Â  if (duckInfo.type === 'Virtual Duck') {
Â  Â  Â  Â  const oneDayAgo = new Date().getTime() - (24 * 60 * 60 * 1000);
Â  Â  Â  Â  localVirtualScanTimestamps = localVirtualScanTimestamps.filter(ts => ts > oneDayAgo);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (localVirtualScanTimestamps.length >= VIRTUAL_LIMIT) {Â 
Â  Â  Â  Â  Â  Â  triggerVisualError();Â 
Â  Â  Â  Â  Â  Â  displayErrorPopup(`Daily limit of ${VIRTUAL_LIMIT} Virtual Ducks reached.`);
Â  Â  Â  Â  Â  Â  triggerFrostAnimation();
Â  Â  Â  Â  Â  Â  processingDucks.delete(lookupId); // Unlock immediately if failed local check
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  localVirtualScanTimestamps.push(new Date().getTime());
Â  Â  }

Â  Â  // Perform Optimistic Update...Â 
Â  Â  scanQueue.push({ duckId: finalDuckId, studentId: currentUser.studentId });
Â  Â Â 
Â  Â  const points = duckInfo.points || 0;
Â  Â Â 
Â  Â  // ğŸŒŸ OPTIMISTIC UPDATE: Immediate Visual Feedback ğŸŒŸ
Â  Â  currentUser.points += points;
Â  Â  document.getElementById('player-points').textContent = currentUser.points;
Â  Â  document.getElementById('player-ducks').textContent = parseInt(document.getElementById('player-ducks').textContent) + 1;


Â  Â  const isGoldenDuck = duckInfo.type === 'Golden Duck';
Â  Â  // Still show the points pop-up to indicate the scan was captured.
Â  Â  displaySuccessPopup(`+${points}`, isGoldenDuck);Â 
Â  Â  if (isGoldenDuck) {
Â  Â  Â  Â  triggerGoldenDuckAnimation();
Â  Â  } else {
Â  Â  Â  Â  triggerDuckAnimation();
Â  Â  }
}

async function sendBatchScans() {
Â  Â  if (scanQueue.length === 0) return;
Â  Â Â 
Â  Â  const scansToSend = [...scanQueue];
Â  Â  scanQueue = [];
Â  Â Â 
Â  Â  const sentDuckIds = new Set(scansToSend.map(s => s.duckId.trim().toLowerCase()));Â 

Â  Â  const batchResult = await postToAction('batchScanDucks', { scans: scansToSend });
Â  Â Â 
Â  Â  // --- UNLOCK ALL DUCKS THAT WERE SENT (FINALLY) ---
Â  Â  sentDuckIds.forEach(id => processingDucks.delete(id));

Â  Â  if (batchResult.status === "success") {
Â  Â  Â  Â  if (batchResult.results) {
Â  Â  Â  Â  Â  Â  batchResult.results.forEach(result => {
Â  Â  Â  Â  Â  Â  Â  Â  const id = result.duckId.trim().toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  const duckInfo = duckDataCache[id];
Â  Â  Â  Â  Â  Â  Â  Â  const points = duckInfo ? duckInfo.points : 0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (result.status === "success") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  claimedDucksCache.add(id);Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ğŸŒŸ REVERT OPTIMISTIC UPDATE if the server failed the scan ğŸŒŸ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUser.points = Math.max(0, currentUser.points - points);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('player-points').textContent = currentUser.points;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('player-ducks').textContent = Math.max(0, parseInt(document.getElementById('player-ducks').textContent) - 1);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayRevertPopup(result.message || "A duck was claimed just before you!");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  // Sync counts from the batch result immediately to reduce the gap until the 60s sync
Â  Â  Â  Â  if (batchResult.updatedUser) {
Â  Â  Â  Â  Â  Â  currentUser.points = batchResult.updatedUser.points;
Â  Â  Â  Â  Â  Â  document.getElementById('player-points').textContent = currentUser.points;
Â  Â  Â  Â  Â  Â  if (batchResult.updatedUser.duckCount !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('player-ducks').textContent = batchResult.updatedUser.duckCount;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  displayRevertPopup(batchResult.message || "A server error occurred.");
Â  Â  Â  Â  // Re-queue the failed scans to be retried
Â  Â  Â  Â  scanQueue = [...scansToSend, ...scanQueue];
Â  Â  }
}

function periodicDataRefresh() {
if (!currentUser) return;
// ğŸŒŸ This is the 60-second server sync/correction point ğŸŒŸ
updateUserDashboard(true);Â 

postToAction('getClaimedDucks').then(result => {
if (result.status === 'success' && Array.isArray(result.claimed)) {
claimedDucksCache = new Set(result.claimed);
}
});
// Fetch auxiliary data in the background if it's old
const fiveMinutes = 5 * 60 * 1000;
if (!infoDataFetchTime || (new Date() - infoDataFetchTime > fiveMinutes)) {
Â  Â  postToAction('getInfoData').then(result => {
Â  Â  Â  Â  if (result.status === 'success') {
Â  Â  Â  Â  Â  Â  updateRibbon(result.ribbonText);
Â  Â  Â  Â  Â  Â  infoDataCache = result.infoItems || [];
Â  Â  Â  Â  Â  Â  infoDataFetchTime = new Date();
Â  Â  Â  Â  Â  Â  if (document.getElementById('info-page').classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  renderInfoCards(infoDataCache);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  updateRibbon('');
Â  Â  Â  Â  }
Â  Â  });
}
}

// --- APP INITIALIZATION & LOGIN ---
async function showApp(user, initialPageId, loginButtonEl, loginButtonContent) {
Â  Â  currentUser = user;
Â  Â  sessionStorage.setItem('currentUserStudentId', user.studentId);
Â  Â Â 
Â  Â  // 1. Load CRITICAL Data (Duck Map & Claimed Status) - MUST COMPLETE BEFORE UI IS SHOWN
Â  Â  try {
Â  Â  Â  Â  const [duckResult, claimedDucksResult] = await Promise.all([
Â  Â  Â  Â  Â  Â  postToAction('getDuckData'),
Â  Â  Â  Â  Â  Â  postToAction('getClaimedDucks')
Â  Â  Â  Â  ]);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (duckResult.status === "success") {
Â  Â  Â  Â  Â  Â  duckDataCache = duckResult.ducks;
Â  Â  Â  Â  } else { throw new Error("Failed to load duck data."); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (claimedDucksResult.status === "success" && Array.isArray(claimedDucksResult.claimed)) {
Â  Â  Â  Â  Â  Â  claimedDucksCache = new Set(claimedDucksResult.claimed);
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Failed to load critical game data:", e);
Â  Â  Â  Â  alert("Could not load critical game data. Please try again.");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ensure buttons are functional if critical load fails
Â  Â  Â  Â  if (loginButtonEl) {
Â  Â  Â  Â  Â  Â  loginButtonEl.innerHTML = loginButtonContent;
Â  Â  Â  Â  Â  Â  loginButtonEl.disabled = false;
Â  Â  Â  Â  }
Â  Â  Â  Â  return;Â 
Â  Â  }

Â  Â  // ğŸ›‘ FIX: Reset the login button immediately after critical data loads,Â 
Â  Â  // but before the UI transition. This eliminates the flicker.
Â  Â  if (loginButtonEl) {
Â  Â  Â  Â  loginButtonEl.innerHTML = loginButtonContent;
Â  Â  Â  Â  loginButtonEl.disabled = false;
Â  Â  }
Â  Â Â 
Â  Â  // 2. Show UI and Start Scanner Immediately
Â  Â  loginScreen.classList.remove('visible');
Â  Â  appWrapper.classList.add('visible');
Â  Â Â 
Â  Â  // Set up timers
Â  Â  if (batchSendTimer) clearInterval(batchSendTimer);
Â  Â  batchSendTimer = setInterval(sendBatchScans, BATCH_SEND_INTERVAL_MS);
Â  Â  if (dataRefreshTimer) clearInterval(dataRefreshTimer);
Â  Â  dataRefreshTimer = setInterval(periodicDataRefresh, DATA_REFRESH_INTERVAL_MS);
Â  Â Â 
Â  Â  // Start scanner and switch to initial page
Â  Â  switchPage(initialPageId);Â 
Â  Â Â 
Â  Â  // Process initial duck QR code from URL if present
Â  Â  if (initialDuckId) {
Â  Â  Â  Â  onScanSuccess(initialDuckId);
Â  Â  Â  Â  initialDuckId = null;
Â  Â  }

Â  Â  // 3. Load AUXILIARY Data (Asynchronously, in the background)
Â  Â  try {
Â  Â  Â  Â  const [historyResult, infoResult] = await Promise.all([
Â  Â  Â  Â  Â  Â  postToAction('getScanHistory', { studentId: currentUser.studentId }),
Â  Â  Â  Â  Â  Â  postToAction('getInfoData')
Â  Â  Â  Â  ]);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (Array.isArray(historyResult)) {
Â  Â  Â  Â  Â  Â  scanHistoryCache = historyResult;
Â  Â  Â  Â  Â  Â  document.getElementById('player-ducks').textContent = historyResult.length;Â 
Â  Â  Â  Â  Â  Â  const oneDayAgo = new Date().getTime() - (24 * 60 * 60 * 1000);
Â  Â  Â  Â  Â  Â  localVirtualScanTimestamps = historyResult
Â  Â  Â  Â  Â  Â  Â  Â  .filter(scan => scan.duckType === 'Virtual Duck' && new Date(scan.timestamp).getTime() > oneDayAgo)
Â  Â  Â  Â  Â  Â  Â  Â  .map(scan => new Date(scan.timestamp).getTime());
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (infoResult.status === 'success') {
Â  Â  Â  Â  Â  Â  updateRibbon(result.ribbonText);
Â  Â  Â  Â  Â  Â  infoDataCache = infoResult.infoItems || [];
Â  Â  Â  Â  Â  Â  infoDataFetchTime = new Date();
Â  Â  Â  Â  Â  Â  if (document.getElementById('info-page').classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  renderInfoCards(infoDataCache);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Failed to load auxiliary data in background:", e);
Â  Â  }
Â  Â Â 
Â  Â  // Final update to set the welcome message and rank
Â  Â  await updateUserDashboard();
}

async function signIn(studentId) {
Â  Â  const signinBtn = document.getElementById('signin-btn');
Â  Â  const originalContent = signinBtn.innerHTML;
Â  Â Â 
Â  Â  // IMMEDIATE UX FEEDBACK: Show spinner and disable button
Â  Â  signinBtn.innerHTML = '<div class="spinner"></div>';
Â  Â  signinBtn.disabled = true;

Â  Â  const result = await postToAction('getUser', { studentId });
Â  Â Â 
Â  Â  if (result.status === "success") {
Â  Â  Â  Â  // SUCCESS: Pass button state to showApp
Â  Â  Â  Â  showApp(result.user, 'hunt-page', signinBtn, originalContent);Â 
Â  Â  } else {
Â  Â  Â  Â  // FAILURE: Reset button state
Â  Â  Â  Â  signinBtn.innerHTML = originalContent;
Â  Â  Â  Â  signinBtn.disabled = false;
Â  Â  Â  Â  alert("User not found! Please register before signing in.");
Â  Â  }
}

async function registerUser() {
Â  Â  const submitBtn = document.getElementById('submit-btn');
Â  Â  const originalContent = submitBtn.innerHTML;

Â  Â  // VALIDATION (Quick local checks)
Â  Â  const payload = {
Â  Â  Â  Â  firstName: document.getElementById('reg-firstname').value.trim(),
Â  Â  Â  Â  lastName: document.getElementById('reg-lastname').value.trim(),
Â  Â  Â  Â  studentId: document.getElementById('reg-studentid').value.trim(),
Â  Â  Â  Â  email: document.getElementById('reg-email').value.trim()
Â  Â  };
Â  Â Â 
Â  Â  if (!payload.firstName || !payload.studentId) {
Â  Â  Â  Â  return alert("First Name and Student ID are required.");
Â  Â  }
Â  Â  if (!payload.email.toLowerCase().endsWith('@my.gcu.edu')) {
Â  Â  Â  Â  return alert("Registration requires an @my.gcu.edu email address.");
Â  Â  }
Â  Â Â 
Â  Â  // IMMEDIATE UX FEEDBACK: Show spinner and disable button
Â  Â  submitBtn.innerHTML = '<div class="spinner"></div>';
Â  Â  submitBtn.disabled = true;

Â  Â  try {
Â  Â  Â  Â  const result = await postToAction('registerUser', payload);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (result.status === "success") {
Â  Â  Â  Â  Â  Â  const userResult = await postToAction('getUser', { studentId: payload.studentId });
Â  Â  Â  Â  Â  Â  if (userResult.status === "success") {
Â  Â  Â  Â  Â  Â  Â  Â  // SUCCESS: Pass button state to showApp
Â  Â  Â  Â  Â  Â  Â  Â  showApp(userResult.user, 'hunt-page', submitBtn, originalContent);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Auto sign-in failed after registration.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // FAILURE: Reset button state
Â  Â  Â  Â  Â  Â  submitBtn.innerHTML = originalContent;
Â  Â  Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  Â  Â  alert(result.message);
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  // CATCH FAILURE: Reset button state
Â  Â  Â  Â  submitBtn.innerHTML = originalContent;
Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  alert("Error registering. Please check your Student ID and try again.");
Â  Â  }
}
// --- UI & DATA DISPLAY FUNCTIONS ---
function displaySuccessPopup(message, isGolden = false) {
const successPop = document.createElement('div');
successPop.className = 'point-pop';
if (isGolden) {
successPop.classList.add('golden-point-pop');
}
successPop.textContent = message;
document.getElementById('qr-reader-container').appendChild(successPop);
setTimeout(() => successPop.remove(), POPUP_DURATION_MS);
}
function displayErrorPopup(message) {
const errorPop = document.createElement('div');
errorPop.className = 'point-pop';
errorPop.style.background = '#d9534f';
errorPop.textContent = message;
document.getElementById('qr-reader-container').appendChild(errorPop);
setTimeout(() => errorPop.remove(), POPUP_DURATION_MS);
}
function displayRevertPopup(message) {
const revertPop = document.createElement('div');
revertPop.className = 'point-pop';
revertPop.style.background = '#f0ad4e';
revertPop.innerHTML = `<strong>Points Reverted</strong><br><small>${message}</small>`;
document.getElementById('qr-reader-container').appendChild(revertPop);
setTimeout(() => revertPop.remove(), POPUP_DURATION_MS + 1000);
}
async function updateUserDashboard(shouldUpdatePoints = true) {
if (!currentUser) return;
try {
Â  Â  const fetches = [
Â  Â  Â  Â  postToAction('getLeaderboard'),
Â  Â  Â  Â  postToAction('getScanHistory', { studentId: currentUser.studentId })
Â  Â  ];
Â  Â  if (shouldUpdatePoints) {
Â  Â  Â  Â  fetches.unshift(postToAction('getUser', { studentId: currentUser.studentId }));
Â  Â  }
Â  Â  const responses = await Promise.all(fetches);

Â  Â  let userResult, leaderboardData, historyResult;
Â  Â  Â  Â Â 
Â  Â  const hasPendingScans = scanQueue.length > 0;
Â  Â  Â  Â Â 
Â  Â  if (shouldUpdatePoints) {
Â  Â  Â  Â  userResult = responses.shift();
Â  Â  Â  Â  if (userResult.status === "success") {
Â  Â  Â  Â  Â  Â  currentUser.points = userResult.user.points;
Â  Â  Â  Â  Â  Â  document.getElementById('player-points').textContent = currentUser.points;
Â  Â  Â  Â  Â  Â  if (userResult.user.duckCount !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser.duckCount = userResult.user.duckCount;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('player-ducks').textContent = currentUser.duckCount;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } 

Â  Â  const leaderboardIndex = shouldUpdatePoints ? 0 : 0;
Â  Â  const historyIndex = shouldUpdatePoints ? 1 : 1;Â 

Â  Â  leaderboardData = responses[leaderboardIndex];
Â  Â  historyResult = responses[historyIndex];

Â  Â  document.getElementById('welcome-message').textContent = `Welcome, ${currentUser.firstName}!`;

Â  Â  if (Array.isArray(leaderboardData)) {
Â  Â  Â  Â  const myRank = leaderboardData.findIndex(p => String(p.studentId).trim() === String(currentUser.studentId).trim()) + 1;
Â  Â  Â  Â  let rankText = myRank > 0 ? `Rank: ${myRank}` : 'Not Yet Ranked';
Â  Â  Â  Â  if (myRank === 1) rankText = 'ğŸ¥‡ Rank 1';
Â  Â  Â  Â  else if (myRank === 2) rankText = 'ğŸ¥ˆ Rank 2';
Â  Â  Â  Â  else if (myRank === 3) rankText = 'ğŸ¥‰ Rank 3';
Â  Â  Â  Â  document.getElementById('player-rank-display').textContent = rankText;
Â  Â  }

Â  Â  if (Array.isArray(historyResult)) {
Â  Â  Â  Â  scanHistoryCache = historyResult;
Â  Â  Â  Â  if (!hasPendingScans) {
Â  Â  Â  Â  Â  Â  document.getElementById('player-ducks').textContent = historyResult.length;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  Â  Â Â 
} catch (e) {
Â  Â  console.error("Failed to update dashboard", e);
}
}
async function updateLeaderboard() {
const listElement = document.getElementById('leaderboard-list');
if (listElement.innerHTML === '') {
listElement.innerHTML = '<li class="list-item" style="justify-content:center;"><div class="spinner"></div></li>';
}
const leaderboardData = await postToAction('getLeaderboard');Â 
if (!Array.isArray(leaderboardData) || leaderboardData.length === 0) {
listElement.innerHTML = '<li class="list-item" style="justify-content:center;">No one has scanned any ducks yet!</li>';
return;
}
let html = '';
leaderboardData.slice(0, 10).forEach((player, index) => {
const rank = index + 1;
const emoji = rank === 1 ? 'ğŸ†' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `${rank}.`;
const lastNameInitial = (player.lastName && player.lastName.length > 0) ? `${player.lastName.charAt(0)}.` : '';
const displayName = `${player.firstName} ${lastNameInitial}`;
html += `<li class="list-item"><div>${emoji}<div class="rank-text">${displayName}</div></div><span>${player.points} pts</span></li>`;
});
listElement.innerHTML = html;
}
function updateScanHistory() {
const listElement = document.getElementById('log-list');
const scanData = scanHistoryCache;
if (!scanData || scanData.length === 0) {
Â  Â  if (scanHistoryCache.length === 0 && !document.querySelector('#log-list .spinner')) {
Â  Â  Â  Â  listElement.innerHTML = '<li class="list-item" style="justify-content:center;"><div class="spinner"></div></li>';
Â  Â  } else {
Â  Â  Â  Â  listElement.innerHTML = '<li class="list-item" style="justify-content:center;">You haven\'t scanned any ducks yet.</li>';
Â  Â  }
Â  Â  return;
}
let html = '';
scanData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(scan => {
const scanDate = new Date(scan.timestamp);
const timeString = scanDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
const duckTypeDisplay = scan.duckType === 'Golden Duck' ? 'ğŸ¥‡ Golden Duck' : scan.duckType || 'Duck';
html += `<li class="list-item"><div><div class="primary-text">${duckTypeDisplay}</div><div class="secondary-text">${scan.duckId} - ${timeString}</div></div><span>+${scan.points || 0}</span></li>`;
});
listElement.innerHTML = html;
}
// --- INFO PAGE FUNCTIONS ---
function showInfoModal(title, content) {
document.getElementById('modal-title').textContent = title || "Information Detail";
const contentEl = document.getElementById('modal-content');

let html = '';
if (typeof content === 'string') {
html = content.split('\n').map(p => `<p>${p}</p>`).join('');
} else if (Array.isArray(content)) {
html = '<ul>' + content.map(item => `<li>${item}</li>`).join('') + '</ul>';
} else {
html = "<p>No content available.</p>";
}
contentEl.innerHTML = html;

document.getElementById('info-modal-backdrop').style.display = 'flex';
document.body.style.overflow = 'hidden';
}

function renderInfoCards(infoItems) {
const container = document.getElementById('info-container');
if (!infoItems || infoItems.length === 0) {
container.innerHTML = "<h4 style='text-align:center; color:rgba(255,255,255,0.7);'>No information is available at this time.</h4>";
return;
}

let html = '';
infoItems.forEach((item, index) => {
html += `
<div class="info-card-button" data-info-index="${index}">
<h4>${item.title || 'Untitled'}</h4>
</div>
`;
});
container.innerHTML = html;

document.querySelectorAll('.info-card-button').forEach(button => {
button.addEventListener('click', (e) => {
const index = e.currentTarget.dataset.infoIndex;
const infoItem = infoDataCache[index];
if (infoItem) {
showInfoModal(infoItem.title, infoItem.content);
}
});
});
}

async function fetchAndRenderInfoData() {
const container = document.getElementById('info-container');
const fiveMinutes = 5 * 60 * 1000;

if (!infoDataCache || infoDataCache.length === 0) {
container.innerHTML = '<div class="spinner" style="margin-top: 2rem;"></div>';
}

// Use cached data if it's recent (less than 5 minutes old)
if (infoDataCache.length > 0 && infoDataFetchTime && (new Date() - infoDataFetchTime < fiveMinutes)) {
renderInfoCards(infoDataCache);
return;
}

const result = await postToAction('getInfoData');
if (result.status === 'success') {
updateRibbon(result.ribbonText);
infoDataCache = result.infoItems || [];
infoDataFetchTime = new Date();
renderInfoCards(infoDataCache);
} else {
updateRibbon('');
container.innerHTML = "<h4 style='text-align:center; color:rgba(255,255,255,0.7);'>Could not load information. Please try again later.</h4>";
}
}
// --- UTILITY & NAVIGATION ---
function startScanner() {
if (document.getElementById('hunt-page')?.classList.contains('active')) {
html5QrCode = new Html5Qrcode("qr-reader");
const config = { fps: 10, qrbox: { width: 220, height: 220 }, aspectRatio: 1.0 };
html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, () => {}).catch(err => {});
}
}
function stopScanner() {
if (html5QrCode && html5QrCode.isScanning) {
html5QrCode.stop().catch(err => {});
}
}
function switchPage(pageId) {
stopScanner();
if (mapResizeObserver) {
mapResizeObserver.disconnect();
mapResizeObserver = null;
}
document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
document.getElementById(pageId)?.classList.add('active');
document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
document.querySelector(`.tab-button[data-page="${pageId}"]`)?.classList.add('active');

const appContainer = document.getElementById('app-container');
appContainer.scrollTop = 0;

if (pageId === 'hunt-page') {
updateUserDashboard(scanQueue.length === 0);
setTimeout(startScanner, 250);
} else if (pageId === 'leaderboard-page') {
updateLeaderboard();
} else if (pageId === 'log-page') {
updateScanHistory();
} else if (pageId === 'map-page') {
initializeMap();Â 
} else if (pageId === 'info-page') {
fetchAndRenderInfoData();
}
}
function checkForInitialDuck() {
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('duckId')) {
initialDuckId = urlParams.get('duckId');
showNotification("Duck found! Sign in or register to claim it.");
}
}
function showNotification(message) {
const el = document.createElement('div');
el.className = 'glass-card';
el.style.position = 'fixed';
el.style.top = '-150px';
el.style.left = '50%';
el.style.transform = 'translateX(-50%)';
el.style.zIndex = '999';
el.style.width = '80%';
el.maxWidth = '350px';
el.innerHTML = `<p>${message}</p>`;
document.body.appendChild(el);
setTimeout(() => el.style.top = '20px', 10);
setTimeout(() => {
el.style.top = '-150px';
setTimeout(() => el.remove(), 500);
}, 3000);
}
// --- EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
startRandomFadingDuckFeet();
checkForInitialDuck();
const savedStudentId = sessionStorage.getItem('currentUserStudentId');
if (savedStudentId) {
signIn(savedStudentId);
}
document.getElementById('signin-btn').addEventListener('click', () => {
const studentId = document.getElementById('login-studentid').value.trim();
if (studentId) signIn(studentId);
});
document.getElementById('submit-btn').addEventListener('click', registerUser);
document.getElementById('register-btn').addEventListener('click', () => {
loginView.classList.add('hidden');
registrationView.classList.remove('hidden');
});
document.getElementById('back-btn').addEventListener('click', () => {
registrationView.classList.add('hidden');
loginView.classList.remove('hidden');
});
document.getElementById('close-instructions').addEventListener('click', () => {
document.getElementById('instructions-card').style.display = 'none';
});
document.getElementById('tab-bar').addEventListener('click', (e) => {
if (e.target.matches('.tab-button')) {
switchPage(e.target.dataset.page);
}
});
document.getElementById('scan-history-link').addEventListener('click', (e) => {
e.preventDefault();
switchPage(e.target.dataset.page);
});
const modalBackdrop = document.getElementById('info-modal-backdrop');
if (modalBackdrop) {
document.getElementById('modal-close-btn').addEventListener('click', () => {
modalBackdrop.style.display = 'none';
document.body.style.overflow = 'auto';
});
modalBackdrop.addEventListener('click', (e) => {
if (e.target.id === 'info-modal-backdrop') {
modalBackdrop.style.display = 'none';
document.body.style.overflow = 'auto';
}
});
}
});
</script>
</body>
</html>
