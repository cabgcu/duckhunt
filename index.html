<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Duck Hunt 2025</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
:root {
--green: #60A34D;
--pink: #ff69b4;
--gold: #FFD700;
--background-start: #1c0f29;
--background-end: #0c0a15;
--glass-bg: rgba(0, 0, 0, 0.4); /* Darker Glass */
--glass-blur: 24px;
--glass-border-top: rgba(255, 255, 255, 0.15); /* Slightly less visible top border */
--glass-border-bottom: rgba(255, 255, 255, 0.03); /* Darker bottom border */
--glass-shadow: none;
--inset-shadow: inset 0 1px 1px 0 rgba(255, 255, 255, 0.05); /* Darker inset shadow */
--highlight-color: #ffffff;
--glow-color: rgba(96, 163, 77, 0.8);
--active-glow: 0 0 12px rgba(96, 163, 77, 0.9);
--tab-bar-height: 65px;
--safe-padding: 1rem;
--ribbon-height: 40px;
--frosted-black: rgba(0, 0, 0, 0.85); /* Darker Frosted Black */
--safe-area-top: env(safe-area-inset-top, 0px);
--safe-area-bottom: env(safe-area-inset-bottom, 0px);
--safe-area-left: env(safe-area-inset-left, 0px);
--safe-area-right: env(safe-area-inset-right, 0px);
}
body {
margin: 0;
background-color: #000;
overflow-x: hidden;
font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
color: white;
text-align: center;
position: relative;
height: 100vh; /* Ensures full viewport height */
overflow: hidden; /* Prevents body scrolling */
}
.hidden { display: none !important; }
.spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.button-group button .spinner { width: 18px; height: 18px; border-width: 3px; }
.glass-card {
background: var(--glass-bg);
backdrop-filter: blur(var(--glass-blur));
-webkit-backdrop-filter: blur(var(--glass-blur));
border: 1px solid var(--glass-border-bottom);
border-top-color: var(--glass-border-top);
border-radius: 20px;
box-shadow: var(--glass-shadow);
padding: 1.5rem;
}
.transparent-heading-box { background: none; border: none; border-radius: 10px; padding: 0.75rem 0; margin: 0 auto 1.5rem auto; width: 100%; max-width: 450px; box-sizing: border-box; text-align: center; }
#app-wrapper {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
display: flex;
flex-direction: column;
padding-top: var(--safe-area-top);
transition: padding-top 0.3s ease;
}
#app-wrapper.ribbon-active {
padding-top: calc(var(--ribbon-height) + var(--safe-area-top));
}
#ribbon-message {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: calc(var(--ribbon-height) + var(--safe-area-top));
padding-top: var(--safe-area-top);
background-color: rgba(30, 30, 30, 0.5);
backdrop-filter: blur(15px);
-webkit-backdrop-filter: blur(15px);
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
font-weight: bold;
font-size: 0.85rem;
display: flex;
align-items: center;
overflow: hidden;
z-index: 1000;
box-sizing: border-box;
transition: transform 0.3s ease-out;
transform: translateY(-100%);
}
#ribbon-message.visible {
transform: translateY(0);
}
#ribbon-content {
white-space: nowrap;
display: flex;
align-items: center;
will-change: transform;
color: var(--gold);
height: 100%;
}
#ribbon-content span {
color: white;
font-weight: normal;
padding-left: 8px;
}
.marquee-start {
animation-name: marquee-scroll;
animation-timing-function: linear;
animation-iteration-count: infinite;
}
@keyframes marquee-scroll {
from { transform: translateX(0); }
to { transform: translateX(var(--marquee-distance)); }
}
#app-container {
flex: 1;
overflow-y: auto;
height: calc(100svh - var(--tab-bar-height) - var(--ribbon-height));
padding-bottom: calc(var(--safe-padding) + var(--tab-bar-height) + var(--safe-area-bottom));
}
.app-page {
width: 100%;
min-height: 100%;
box-sizing: border-box;
padding-top: 0;
padding-bottom: 0;
padding-left: max(var(--safe-padding), var(--safe-area-left));
padding-right: max(var(--safe-padding), var(--safe-area-right));
display: none;
flex-direction: column;
gap: 0;
align-items: center;
}
.app-page.active { display: flex; }
.app-page h2 { margin: 0; flex-shrink: 0; text-align: center; }
.app-page .header-image-top {
width: 70%;
max-width: 250px;
margin: 0.2rem auto 0.2rem auto;
display: block;
flex-shrink: 0;
}
#hunt-page { justify-content: flex-start; padding-top: 0; }
#info-page, #map-page, #leaderboard-page, #log-page { justify-content: flex-start; padding-top: 0; }
#hunt-content-wrapper {
position: relative;
width: 100%;
max-width: 350px;
display: flex;
flex-direction: column;
gap: 0.75rem;
align-items: center;
margin-top: 0;
margin-left: auto;
margin-right: auto;
flex-shrink: 0;
}
#qr-reader-container { padding: 0; display: flex; position: relative; width: 100%; aspect-ratio: 1 / 1; max-width: 300px; }
#qr-reader { width: 100%; height: 100%; border-radius: 20px; overflow: hidden; }
#qr-reader-container.error-flash { animation: flash-red 0.5s ease; }
@keyframes flash-red { 0%, 100% { box-shadow: 0 0 10px rgba(0,0,0,0.5); } 50% { box-shadow: var(--glass-shadow), 0 0 25px rgba(255, 0, 0, 0.9); } }
.point-pop {
position: absolute;
top: 85%;
left: 50%;
transform: translate(-50%, -50%);
font-size: 1.5rem;
font-weight: 800;
color: #FFFFFF;
background: rgba(0, 0, 0, 0.7);
border: 2px solid #FFFFFF;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
padding: 0.5rem 1.5rem;
border-radius: 5px;
min-width: 250px;
text-shadow: 0 0 5px rgba(255,255,255,0.5);
animation: float-up-short 3s ease-out forwards;
pointer-events: none;
}
@keyframes float-up-short { 0% { top: 85%; opacity: 1; } 50% { top: 70%; opacity: 1; } 100% { top: 70%; opacity: 0; } }
#golden-flash-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: var(--gold);
z-index: 1001;
opacity: 0;
pointer-events: none;
}
@keyframes gold-flash {
0% { opacity: 0; }
10% { opacity: 0.9; }
50% { opacity: 0.4; }
100% { opacity: 0; }
}
.golden-point-pop {
border-color: var(--gold) !important;
color: var(--gold) !important;
background: rgba(10, 10, 10, 0.9) !important;
box-shadow: 0 0 15px var(--gold), 0 0 5px rgba(255, 215, 0, 0.5) !important;
text-shadow: 0 0 8px #fff !important;
font-size: 1.8rem !important;
}
.footer-logo {
height: 60px; /* Final size */
margin: 0 auto 15px auto;
display: block;
object-fit: contain;
}
#scanner-footer-details {
display: flex;
flex-direction: column;
align-items: center;
gap: 0.75rem;
margin-top: 0.5rem;
flex-shrink: 0;
}
#scan-history-link {
font-size: 1.1rem;
color: var(--green);
text-decoration: underline;
cursor: pointer;
margin-top: 0;
font-weight: bold;
}
#player-rank-display { margin-top: 0; font-size: 1.1rem; font-weight: 600; }
/* --- MAP STYLES --- */
#map-page {
padding-top: var(--safe-padding);
justify-content: flex-start;
}
#map-card-container {
width: 100%;
max-width: 450px;
height: 65vh;
overflow: scroll;
padding: 0;
border-radius: 20px;
margin-left: auto;
margin-right: auto;
}
#map-wrapper {
position: relative;
width: 250vw;
height: auto;
}
#campus-map-img {
width: 100%;
height: auto;
display: block;
}
#map-markers-overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
}
.map-label {
position: absolute;
z-index: 10;
transform: translate(-50%, -50%);
cursor: pointer;
pointer-events: auto;
background: var(--frosted-black);
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
border: 1px solid rgba(255,255,255,0.1);
border-radius: 8px;
padding: 3px 6px;
min-width: 90px;
text-align: center;
white-space: normal;
line-height: 1.2;
transition: transform 0.2s ease-out, z-index 0s 0.2s;
}
.map-label.on-top {
z-index: 20;
transform: translate(-50%, -50%) scale(1.1);
transition: transform 0.2s ease-out, z-index 0s;
}
.map-label h4 {
margin: 0;
font-size: 12px;
font-weight: bold;
color: white;
}
.map-label p {
margin: 0;
padding-top: 2px;
font-size: 10px;
color: rgba(255, 255, 255, 0.9);
}
.map-label.cleared {
border-color: #ff4d4d;
background-color: rgba(50, 50, 50, 0.85);
opacity: 0.8;
}
/* --- End Map Styles --- */
#log-container, #leaderboard-container, #info-container {
flex: 1;
overflow-y: auto;
min-height: 0;
padding: var(--safe-padding) 0;
background: none;
border: none;
box-shadow: none;
gap: 0.75rem;
display: flex;
flex-direction: column;
width: 100%;
max-width: 450px;
margin: 0 auto;
}
/* IMPORTANT: Added padding bottom to clear the fixed tab bar */
#info-page {
padding-bottom: calc(var(--tab-bar-height) + var(--safe-area-bottom) + var(--safe-padding));
}
#leaderboard-page {
padding-bottom: calc(var(--tab-bar-height) + var(--safe-area-bottom) + var(--safe-padding));
}
#log-page {
padding-bottom: calc(var(--tab-bar-height) + var(--safe-area-bottom) + var(--safe-padding));
}
#map-page {
padding-bottom: calc(var(--tab-bar-height) + var(--safe-area-bottom) + var(--safe-padding));
}
#leaderboard-list, #log-list {
list-style: none;
padding: 0;
margin: 0;
width: 100%;
display: flex;
flex-direction: column;
gap: 0.75rem;
}
#info-modal-backdrop {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.7); /* Darker Modal Backdrop */
backdrop-filter: blur(10px);
z-index: 200;
display: none;
align-items: center;
justify-content: center;
}
#info-modal {
position: relative;
width: 90%;
max-width: 400px;
padding: 1.5rem;
max-height: 90vh;
}
#modal-close-btn {
position: absolute;
top: 10px;
right: 10px;
background: none;
border: none;
color: white;
font-size: 2rem;
cursor: pointer;
}
#modal-title {
margin-top: 0;
border-bottom: 2px solid var(--green);
padding-bottom: 0.5rem;
text-align: center !important;
}
#modal-content {
text-align: center;
padding: 0 0.5rem;
max-height: calc(90vh - 120px);
overflow-y: auto;
}
#modal-content ul {
list-style-type: disc;
padding-left: 25px;
text-align: left;
}
#modal-content li {
margin-bottom: 0.5rem;
}
#modal-content p, #modal-content h5, #modal-content h4 {
text-align: center;
}
#modal-content p {
font-size: 0.95rem;
}
.info-card-button {
padding: 1rem 1.5rem;
width: 100%;
text-align: center;
cursor: pointer;
transition: transform 0.2s ease;
margin-bottom: 0.75rem;
box-sizing: border-box;
}
.info-card-button:hover {
transform: scale(1.03);
}
.info-card-button h4 {
margin: 0;
font-size: 1.2rem;
font-weight: bold;
color: white;
}
.list-item {
display: flex;
align-items: center;
justify-content: space-between;
padding: 1rem;
border-radius: 12px;
}
#leaderboard-list .list-item > div:first-child { display: flex; align-items: center; gap: 0.75rem; }
.list-item .rank-text {
font-weight: bold;
font-size: 1.2rem;
white-space: nowrap;
}
#leaderboard-list .list-item span {
font-weight: bold;
font-size: 1.3rem;
color: var(--green);
}
#log-list .list-item > div:first-child { display: flex; flex-direction: column; align-items: flex-start; }
#log-list .list-item .primary-text { font-weight: bold; font-size: 1.1rem; margin-bottom: 0; }
#log-list .list-item .secondary-text { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 0.2rem; }
.button-group { display: flex; gap: 0.5rem; }
.button-group button, .full-width-btn {
flex: 1;
border-radius: 10px;
padding: 12px 15px;
font-size: 1rem;
font-weight: bold;
cursor: pointer;
border: 1px solid var(--glass-border-bottom);
border-top-color: var(--glass-border-top);
transition: all 0.2s ease;
box-shadow: var(--inset-shadow);
min-height: 44px;
box-sizing: border-box;
display: flex;
justify-content: center;
align-items: center;
}
.primary-btn { background-color: var(--green); color: white; border-color: rgba(255, 255, 255, 0.3); }
.secondary-btn { background-color: rgba(0, 0, 0, 0.4); /* Darker Secondary Button */ color: white; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
.primary-btn:hover, .secondary-btn:hover, .full-width-btn:hover { box-shadow: var(--inset-shadow), 0 0 10px var(--glow-color); border-color: var(--green); transform: translateY(-2px); }
/* === LAVA CONTAINER STYLES === */
#lava-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: -1;
overflow: hidden;
}
#lava-container::before, #lava-container::after {
content: '';
position: absolute;
width: 70vmax;
height: 70vmax;
border-radius: 50%;
opacity: 0.8;
mix-blend-mode: lighten;
filter: blur(120px);
}
#lava-container::before {
background-color: var(--pink);
top: -35vmax;
left: -35vmax;
animation: move-pink 14s infinite linear;
}
#lava-container::after {
background-color: var(--green);
bottom: -35vmax;
right: -35vmax;
animation: move-green 12s infinite linear;
animation-delay: -8s;
}
/* === END LAVA STYLES === */
.screen { opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
.screen.visible { opacity: 1; pointer-events: auto; }
#login-screen {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
display: flex;
flex-direction: column;
/* Centers items as a column */
justify-content: center;
align-items: center;
/* Removed scroll, now rely on viewport sizing */
padding-top: calc(var(--safe-padding) + var(--safe-area-top));
padding-bottom: calc(var(--safe-padding) + var(--safe-area-bottom));
}
.reg-input, #login-studentid { background: rgba(0, 0, 0, 0.3); /* Darker Input Background */ border: 1px solid var(--glass-border-bottom); border-top-color: var(--glass-border-top); border-radius: 10px; padding: 12px 15px; font-size: 1rem; color: white; text-align: center; transition: all 0.2s ease; box-shadow: var(--inset-shadow); }
.reg-input:focus, #login-studentid:focus { outline: none; border-color: var(--green); box-shadow: var(--inset-shadow), 0 0 10px var(--glow-color); }
#instructions-card {
position: fixed; /* Fixed to stay at the top */
top: calc(20px + var(--safe-area-top));
left: 50%;
transform: translateX(-50%);
padding: 0.8rem 1.2rem;
border-radius: 12px;
width: 90%;
max-width: 450px;
box-sizing: border-box;
display: flex;
justify-content: space-between;
align-items: center;
z-index: 101;
}
#header-card {
position: relative;
width: 85%;
max-width: 300px;
/* FIX: Adjusted the top margin to pull it up slightly more (50vh - 100px) */
margin-top: calc(50vh - 100px);
margin-bottom: 10px; /* Space above footer */
margin-left: auto; /* Centering fix */
margin-right: auto; /* Centering fix */
flex-shrink: 0;
}
#login-view, #registration-view { display: flex; flex-direction: column; gap: 1.5rem; }
.input-group { display: flex; flex-direction: column; gap: 1rem; }
.terms-group { display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9rem; margin-top: -0.5rem; }
.terms-group input[type="checkbox"] { width: 18px; height: 18px; }
.terms-group label a { color: var(--green); text-decoration: underline; cursor: pointer; }
.login-link-container { margin-top: 1rem; }
.login-link-container a { color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; cursor: pointer; text-decoration: underline; transition: color 0.2s; }
.prize-list-small { text-align: center; list-style: none; padding: 0; margin: 0.5rem 0 0 0; font-size: 0.9rem; }
.prize-list-small li { margin: 3px 0; }
footer {
position: relative;
padding: 10px 10px calc(20px + var(--safe-area-bottom)) 10px;
color: rgba(255, 255, 255, 0.7);
font-size: 0.8rem;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
margin-top: 30px; /* Added extra space below the card */
}
.footer-logo {
height: 60px; /* Final size */
margin: 0 auto 15px auto;
display: block;
object-fit: contain;
}
footer p { margin: 2px 0; }
#scanner-overlay-stats { position: absolute; top: 0; left: 0; right: 0; z-index: 10; background: rgba(0, 0, 0, 0.5); /* Darker Overlay Stats Background */ backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px 20px 0 0; border-bottom: 1px solid var(--glass-border-top); padding: 0.8rem; display: flex; justify-content: space-around; }
.stat { text-align: center; }
.stat h4 { margin: 0; color: rgba(255,255,255,0.7); font-weight: bold; font-size: 0.9rem; }
.stat p { margin: 0; font-size: 1.2rem; font-weight: bold; transition: all 0.3s ease; }
.stat p.pending-update {
animation: pulse-green 1.5s infinite;
}
@keyframes pulse-green {
0% { color: white; text-shadow: none; }
50% { color: var(--green); text-shadow: 0 0 8px var(--green); }
100% { color: white; text-shadow: none; }
}
#tab-bar {
position: fixed;
bottom: 0;
left: 0;
right: 0;
z-index: 150;
background: rgba(0, 0, 0, 0.6); /* Darker Tab Bar */
backdrop-filter: blur(25px);
-webkit-backdrop-filter: blur(25px);
border-top: 1px solid var(--glass-border-top);
display: flex;
justify-content: space-around;
height: calc(var(--tab-bar-height) + var(--safe-area-bottom));
padding-bottom: var(--safe-area-bottom);
box-sizing: content-box;
}
.tab-button {
background: none;
border: none;
color: rgba(255, 255, 255, 0.6);
font-size: 0.9rem;
cursor: pointer;
flex-grow: 1;
font-weight: 600;
transition: color 0.3s ease;
}
.tab-button.active { color: var(--highlight-color); font-weight: bold; text-shadow: 0 0 8px var(--green); }
.duck-animation { position: absolute; top: 50%; left: -50px; font-size: 50px; animation: fly-across 2s linear forwards; pointer-events: none; z-index: 1000; }
.frost-animation { position: absolute; top: -20px; font-size: 1.5rem; color: white; pointer-events: none; z-index: 999; animation: fall-and-fade linear forwards; }
@keyframes fly-across { 0% { transform: translateX(0) translateY(0) rotate(0deg); } 25% { transform: translateX(25vw) translateY(-40px) rotate(15deg); } 50% { transform: translateX(50vw) translateY(0) rotate(0deg); } 75% { transform: translateX(75vw) translateY(-40px) rotate(-15deg); } 100% { transform: translateX(110vw) translateY(0) rotate(0deg); } }
@keyframes fall-and-fade { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
/* === BACKGROUND KEYFRAMES === */
@keyframes move-pink {
0%, 100% { transform: translate(0, 0); }
25% { transform: translate(calc(100vw - 70vmax), 0); }
50% { transform: translate(calc(100vw - 70vmax), calc(100vh - 70vmax)); }
75% { transform: translate(0, calc(100vh - 70vmax)); }
}
@keyframes move-green {
0%, 100% { transform: translate(0, 0); }
25% { transform: translate(calc(-100vw + 70vmax), 0); }
50% { transform: translate(calc(-100vw + 70vmax), calc(-100vh + 70vmax)); }
75% { transform: translate(0, calc(-100vh + 70vmax)); }
}
/* === END LAVA STYLES === */
#duck-feet-background-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: -2;
pointer-events: none;
overflow: hidden;
opacity: 0.5;
}
.fading-duck-feet {
position: absolute;
width: 50px;
height: 50px;
background-image: url('https://i.imgur.com/S23bWc.png');
background-size: contain;
background-repeat: no-repeat;
opacity: 0;
animation: fade-in-out linear forwards;
pointer-events: none;
}
@keyframes fade-in-out {
0% { opacity: 0; transform: scale(0.8); }
20% { opacity: 0.3; transform: scale(1); }
80% { opacity: 0.3; transform: scale(1); }
100% { opacity: 0; transform: scale(1.2); }
}
@media (max-width: 480px) {
.map-label {
min-width: 90px;
padding: 4px 8px;
}
.map-label h4 {
font-size: 12px;
}
.map-label p {
font-size: 10px;
padding-top: 2px;
}
}
/* --- NEW STYLES FOR TORCH AND LOGOUT --- */
#torch-toggle-btn {
position: absolute;
bottom: 15px;
right: 15px;
width: 45px;
height: 45px;
background-color: rgba(0, 0, 0, 0.6); /* Darker torch background */
border: 1px solid rgba(255, 255, 255, 0.1); /* Darker torch border */
border-radius: 50%;
cursor: pointer;
z-index: 15;
display: flex;
align-items: center;
justify-content: center;
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
transition: background-color 0.2s, transform 0.2s;
}
#torch-toggle-btn:hover {
transform: scale(1.1);
}
#torch-toggle-btn.torch-on {
background-color: rgba(255, 255, 255, 0.85);
}
#torch-toggle-btn svg {
width: 24px;
height: 24px;
fill: white;
transition: fill 0.2s;
}
#torch-toggle-btn.torch-on svg {
fill: #000;
}
#logout-btn {
background-color: rgba(100, 20, 20, 0.4); /* Darker logout button */
border-color: rgba(255, 100, 100, 0.1); /* Darker logout border */
color: rgba(255, 150, 150, 1);
margin: 0.75rem auto;
border-radius: 12px;
padding: 1rem 1.5rem; /* Matches info-card padding */
max-width: 350px;
width: 100%;
font-weight: bold;
font-size: 1.2rem; /* Matches info-card h4 */
}
#logout-btn:hover {
background-color: rgba(255, 100, 100, 0.2);
border-color: rgba(255, 100, 100, 0.4);
box-shadow: var(--inset-shadow), 0 0 10px rgba(255, 100, 100, 0.4);
transform: translateY(-2px);
}
</style>
</head>
<body>
<div id="golden-flash-overlay" class="hidden"></div>
<div id="ribbon-message">
<div id="ribbon-content"></div>
</div>
<div id="lava-container"></div>
<div id="duck-feet-background-container"></div>
<div id="login-screen" class="screen visible">
<div class="glass-card" id="instructions-card">
<p>Tap <img src="https://i.imgur.com/wFrSvUH.png" alt="Share Icon" style="height:1.2em; vertical-align:middle; margin: 0 0.2em;"> to Add to Home Screen!</p>
<button id="close-instructions" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
</div>
<div class="glass-card" id="header-card">
<div id="login-view">
<img class="header-image" style="width:100%;" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<input type="text" id="login-studentid" class="reg-input" placeholder="Student ID">
<div class="login-link-container">
<a href="#" id="what-is-duck-hunt-link" data-info-index="4">What is Duck Hunt?</a>
</div>
<div class="button-group">
<button id="signin-btn" class="secondary-btn">Sign In</button>
<button id="register-btn" class="primary-btn">Register</button>
</div>
</div>
<div id="registration-view" class="hidden">
<h3 style="text-align: center;">Welcome To The Hunt!</h3>
<div class="input-group">
<input type="text" id="reg-firstname" class="reg-input" placeholder="First Name"><input type="text" id="reg-lastname" class="reg-input" placeholder="Last Name">
<input type="text" id="reg-studentid" class="reg-input" placeholder="Student ID"><input type="email" id="reg-email" class="reg-input" placeholder="Email @my.gcu.edu">
</div>
<div class="terms-group">
<input type="checkbox" id="terms-checkbox">
<label for="terms-checkbox">I agree to the <a href="#" id="view-terms-link" data-info-index="3">Terms & Conditions</a></label>
</div>
<div class="button-group">
<button id="back-btn" class="secondary-btn">Back</button><button id="submit-btn" class="primary-btn">Submit</button>
</div>
</div>
</div>
<footer>
<img src="https://i.postimg.cc/qv6pFZ03/Untitled-design-2.png" alt="Canyon Activities Board Logo" class="footer-logo">
<p>Follow Us At <b>@CABGCU</b> On Instagram</p>
<p>Hosted by the Canyon Activities Board at Grand Canyon University</p>
</footer>
</div>
<div id="app-wrapper" class="screen">
<main id="app-container">
<section id="hunt-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<div id="hunt-content-wrapper">
<h2 class="transparent-heading-box" id="welcome-message"></h2>
<div id="qr-reader-container" class="glass-card">
<div id="scanner-overlay-stats">
<div class="stat"><h4>POINTS</h4><p id="player-points">0</p></div>
<div class="stat"><h4>DUCKS</h4><p id="player-ducks">0</p></div>
</div>
<div id="qr-reader"></div>
<button id="torch-toggle-btn" class="hidden">
<svg viewBox="0 0 24 24" width="24" height="24">
<path fill="currentColor" d="M9,2A1,1 0 0,0 8,3V4A1,1 0 0,0 9,5H15A1,1 0 0,0 16,4V3A1,1 0 0,0 15,2H9M9,6A1,1 0 0,0 8,7V8A1,1 0 0,0 9,9H15A1,1 0 0,0 16,8V7A1,1 0 0,0 15,6H9M8,10V20A2,2 0 0,0 10,22H14A2,2 0 0,0 16,20V10H8Z"></path>
</svg>
</button>
</div>
<div id="scanner-footer-details">
<a id="scan-history-link" href="#" data-page="log-page">Scan History</a>
<div id="player-rank-display"></div>
</div>
</div>
</section>
<section id="map-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<div id="map-card-container">
<div id="map-wrapper">
<img id="campus-map-img"
src="https://i.imgur.com/1aQCsPk.jpeg"
alt="Interactive Campus Map">
<div id="map-markers-overlay"></div>
</div>
</div>
</section>
<section id="leaderboard-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<h2 class="transparent-heading-box">Leaderboard</h2>
<div id="leaderboard-container"><ul id="leaderboard-list"></ul></div>
</section>
<section id="log-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<h2 class="transparent-heading-box">Scan History</h2>
<div id="log-container"><ul id="log-list"></ul></div>
</section>
<section id="info-page" class="app-page">
<img class="header-image-top" src="https://i.imgur.com/piKjXSd.png" alt="Wicked Movie Header">
<h2 class="transparent-heading-box">Information</h2>
<div id="info-container"></div>
<button id="logout-btn" class="info-card-button glass-card full-width-btn">Logout</button>
</section>
</main>
<nav id="tab-bar">
<button class="tab-button" data-page="hunt-page">Scanner</button>
<button class="tab-button" data-page="leaderboard-page">Leaderboard</button>
<button class="tab-button" data-page="map-page">Map</button>
<button class="tab-button" data-page="info-page">Info</button>
</nav>
</div>
<div id="info-modal-backdrop" style="display: none;">
<div id="info-modal" class="glass-card">
<button id="modal-close-btn">&times;</button>
<h3 id="modal-title"></h3>
<div id="modal-content"></div>
</div>
</div>
<script>
// --- CONFIGURATION ---
// ⚠️ CRITICAL: Replace this with the URL you get after redeploying the optimized Google Apps Script.
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzos8nCC0PpEQ_AaOiVjkkS4J8i4HRsa8aTX4rMDm5LNCMhSTRmU1KgpqLK2nNI2Awx/exec';
const POPUP_DURATION_MS = 2000;
const BATCH_SEND_INTERVAL_MS = 45000; // Increased to 45 seconds for better backend throughput
const DATA_REFRESH_INTERVAL_MS = 60000; // Increased to 1 minute to reduce continuous load
const VIRTUAL_LIMIT = 10;
const VIRTUAL_LOCATIONS = ['Commuter Lounge', 'Thunderground', 'Riverbed'];
const MAP_SPOTS = [
{ name: 'The Grove', dataKey: 'The Grove', coords: '1295,758,1311,774' },
{ name: 'Lopes Way', dataKey: 'Lopes Way', coords: '2270,1911,2286,1927' },
{ name: 'Main Campus', dataKey: 'Main Campus', coords: '1763,2398,1779,2414' },
{ name: 'North Campus', dataKey: 'North Campus', coords: '2738,1116,2754,1132' },
{ name: 'East Campus', dataKey: 'East Campus', coords: '3882,2468,3898,2484' },
{ name: 'The Rivers', dataKey: 'The Rivers', coords: '4757,1136,4773,1152' },
{ name: 'Riverbed Virtual', dataKey: 'Riverbed', coords: '5125,817,5141,833' },
{ name: 'Commuter Lounge Virtual', dataKey: 'Commuter Lounge', coords: '1355,1900,1371,1916' },
{ name: 'Thunderground Virtual', dataKey: 'Thunderground', coords: '1514,1680,1530,1696' },
];
// --- GLOBAL STATE & DOM REFERENCES ---
let html5QrCode = null;
let currentUser = null;
let initialDuckId = null;
let infoDataFetchTime = null;
let mapResizeObserver = null;
let isTorchOn = false;
let cameraTrack = null;
const loginScreen = document.getElementById('login-screen');
const appWrapper = document.getElementById('app-wrapper');
const loginView = document.getElementById('login-view');
const registrationView = document.getElementById('registration-view');
const ribbonMessage = document.getElementById('ribbon-message');
const mapImageElement = document.getElementById('campus-map-img');
// Pre-populated Info Data (Refactored)
const infoDataCache = [
{
title: 'How to Play & Duck Types',
content: [
"**Get Started:** Use the **Scanner** tab to find and scan QR codes hidden around campus. The **Map** shows general areas where ducks are still available.",
"**Earn Points:** Each duck grants points depending on its type. Only the **first student** to scan a unique code earns the points; after that, the code is inactive (a 'dead code').",
"**Track Progress:** Check the **Leaderboard** for your rank and use **Scan History** to track your finds.",
"**Event Dates:** Virtual ducks start the week of **October 27th**. The physical hunt runs from **November 3rd to November 8th**.",
"",
"**Duck Values:**",
"🥇 Golden Duck (3 total): **2,000 pts**",
"👑 Student Engagement Duck: **1,000 pts**",
"🦆 Physical Ducks (3,000+ total): **100 pts**",
"💻 Virtual Ducks (Max " + VIRTUAL_LIMIT + "/day): **25 pts**"
]
},
{
title: 'Prizes & Eligibility (The Stakes)',
content: [
"The **TOP THREE POINT EARNERS** on the final leaderboard will win massive prizes to celebrate Lip Sync 2025!",
"",
"### Grand Prizes:",
"🥇 **1st Place: VIP Lip Sync Experience!**",
"Get VIP tickets for up to four people.",
"🥈 **2nd Place: Stampede Fuel!**",
"Enjoy free Stampede for two months.",
"🥉 **3rd Place: Lope Shop Shopping Spree!**",
"Win a $200 Lope Shop shopping spree with Thunder.",
"",
"**Eligibility:** You must be a verified GCU student with a valid **@my.gcu.edu** email and only **one account** per student is permitted to claim a prize."
]
},
{
title: 'Fair Play Rules',
content: [
"Play fair and respect all other participants and campus property.",
"Do **NOT** share duck links, screenshots, or QR codes online.",
"Do **NOT** hack, alter, or interfere with the website or QR system.",
"Do **NOT** enter restricted, staff-only, or unsafe areas.",
"Uphold GCU’s community standards and have fun promoting Lip Sync 2025!"
]
},
{
title: 'Duck Hunt 2025 – Terms & Conditions',
content: [
"**1. Purpose**",
"Duck Hunt 2025 is a campus-wide scavenger hunt hosted by the Canyon Activities Board (CAB) at Grand Canyon University, created to promote and celebrate Lip Sync 2025. The event encourages students to explore campus, connect with others, and show school spirit through a fun, interactive competition. Participants will search for hidden ducks, scan their unique QR codes, and compete to reach the top of the leaderboard for prizes.",
"**2. Eligibility**",
"Participation is open exclusively to GCU traditional on-ground students and commuter traditional students. All participants must register using their Student ID and @my.gcu.edu email address. Each student may only have one account. Duplicate or shared accounts are not permitted.",
"**3. How to Play**",
"Visit cabgcuduckhunt.com and log in using your GCU student information. Find QR-coded “ducks” hidden around campus. Scan each duck through the Duck Hunt web app to earn points. Once a duck is scanned by any player, it becomes inactive (“dead code”) and cannot be reused.",
"**Duck Types & Point Values:** Golden Ducks (3 total): 2,000 points each. Student Engagement Ducks: 1,000 points each. Physical Ducks (3,000+ hidden): 100 points each. Virtual Ducks (10,000 total): 25 points each. Virtual Ducks can be found at the Commuter Lounge, Thunderground, The Riverbed, and the Multicultural Office, as well as at CAB events and on promotional flyers.",
"**4. Special Ducks**",
"Each Student Engagement group receives one Special Duck worth 1,000 points. Groups have complete freedom in how they distribute their duck—whether through an event, social media challenge, or creative campus placement. Groups are asked to release their Special Duck no earlier than November 3rd, when the physical hunt begins. The student who finds and scans the Special Duck first automatically earns 1,000 points and keeps the duck as a souvenir.",
"**5. Fair Play & Integrity**",
"Duck Hunt is meant to be a fun, fair, and community-focused event. The following actions are strictly prohibited: Hacking, altering, or exploiting the website or QR code system. Sharing duck links, screenshots, or QR codes online. Using bots, automation, or fake accounts to collect ducks. Registering under multiple names or providing false information. If cheating or manipulation is detected, the participant’s account and points may be removed.",
"**6. Safety & Conduct**",
"Participants are expected to play responsibly and respect the GCU campus community. Do not enter restricted, staff-only, or unsafe areas. Avoid disrupting classes, offices, or campus operations. Stay aware of your surroundings while exploring. Be courteous to others and uphold GCU’s community standards. Duck Hunt is designed to celebrate GCU spirit and promote Lip Sync 2025, not to interfere with campus life.",
"**7. Prizes**",
"The top three players on the final leaderboard will win the following prizes: 🥇 First Place: VIP Lip Sync tickets for up to four people. 🥈 Second Place: Free Stampede for two months. 🥉 Third Place: $200 Lope Shop shopping spree with Thunder. Winners will be contacted through cab@gcu.edu once results are finalized.",
"**8. Event Schedule**",
"Virtual Duck Launch: Week of October 27, 2025. Physical Hunt: November 3 – November 8, 2025.",
"**9. Privacy & Data**",
"By registering, participants agree to share limited information (name, Student ID, and GCU email) used only for event participation, leaderboard tracking, and prize notification. Leaderboard names will display as first name + last initial for privacy.",
"**10. Agreement**",
"By registering and participating in Duck Hunt 2025, you acknowledge that you have read and agree to these Terms & Conditions. Duck Hunt exists to build campus spirit, encourage friendly competition, and promote Lip Sync 2025 in a positive, engaging way."
]
},
{
title: 'What is Duck Hunt?',
content: [
"Duck Hunt is the ultimate campus-wide scavenger hunt hosted by the Canyon Activities Board (CAB) to celebrate Lip Sync 2025!",
"Students find hidden QR-coded ducks, scan them to earn points, and compete for massive prizes at the top of the leaderboard.",
"",
"**Event Dates:** Virtual Hunt starts **October 27th**. Physical Hunt runs **November 3rd - November 8th**.",
"",
"### Prizes:",
"🥇 **1st Place:** VIP Lip Sync Tickets",
"🥈 **2nd Place:** 2 Months Free Stampede",
"🥉 **3rd Place:** $200 Lope Shop Spree",
"",
"### Check out the Lip Sync 2025 Promo Video!",
`<iframe width="100%" height="200" src="https://www.youtube.com/embed/6I-lgo3Vu_8" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`,
"",
"Ready to hunt? Sign in above!"
]
},
{
title: 'Contact & Support',
content: "Duck Hunt is hosted by the Canyon Activities Board (CAB). For questions or support, please contact us on Instagram at @CABGCU."
}
];
// --- CACHING & STATE ---
let duckDataCache = {};
let claimedDucksCache = new Set();
let processingDucks = new Set();
let localVirtualScanTimestamps = [];
let scanQueue = [];
let batchSendTimer = null;
let dataRefreshTimer = null;
let locationCountsCache = {};
let pendingPoints = 0;
let pendingDucks = 0;
// --- PERSISTENCE FUNCTIONS ---
function getQueueKey() {
// Uses studentId to save the queue uniquely for each user
return 'scanQueue_' + (currentUser ? currentUser.studentId : 'guest');
}
function saveScanQueue() {
if (currentUser) {
localStorage.setItem(getQueueKey(), JSON.stringify(scanQueue));
}
}
function loadScanQueue() {
if (!currentUser) return;
const savedQueue = localStorage.getItem(getQueueKey());
if (savedQueue) {
try {
const parsedQueue = JSON.parse(savedQueue);
if (Array.isArray(parsedQueue) && parsedQueue.length > 0) {
scanQueue = parsedQueue;
// Re-apply optimistic points from loaded queue
scanQueue.forEach(scan => {
const duckInfo = duckDataCache[scan.duckId.trim().toLowerCase()];
if (duckInfo) {
pendingPoints += duckInfo.points || 0;
pendingDucks += 1;
}
});
updateOptimisticDisplay();
showNotification(`Loaded ${scanQueue.length} pending scans from last session.`);
}
} catch(e) {
console.error("Error loading scan queue:", e);
localStorage.removeItem(getQueueKey());
}
}
}
// --- MAP INTERACTION LOGIC ---
const mapCardContainer = document.getElementById('map-card-container');
let isPanning = false;
function updateLabelSizeOnPan() {
if (!isPanning) return;
const viewportCenterX = mapCardContainer.scrollLeft + mapCardContainer.clientWidth / 2;
const viewportCenterY = mapCardContainer.scrollTop + mapCardContainer.clientHeight / 2;
const maxDistance = Math.sqrt(Math.pow(mapCardContainer.clientWidth / 2, 2) + Math.pow(mapCardContainer.clientHeight / 2, 2));
document.querySelectorAll('.map-label').forEach(label => {
const labelCenterX = label.offsetLeft + (label.offsetWidth / 2);
const labelCenterY = label.offsetTop + (label.offsetHeight / 2);
const distance = Math.sqrt(Math.pow(labelCenterX - viewportCenterX, 2) + Math.pow(labelCenterY - viewportCenterY, 2));
let scale = 1.15 - (distance / maxDistance) * 0.25;
if (label.classList.contains('on-top')) {
scale = 1.1;
} else {
scale = Math.max(0.9, Math.min(scale, 1.15));
}
label.style.transform = `translate(-50%, -50%) scale(${scale})`;
});
isPanning = false;
}
function positionMarkers() {
const overlay = document.getElementById('map-markers-overlay');
if (!overlay || !mapImageElement || !mapImageElement.naturalWidth) return;
overlay.innerHTML = '';
const locationData = locationCountsCache;
MAP_SPOTS.forEach(spot => {
const marker = document.createElement('div');
marker.className = 'map-label';
const [x1, y1, x2, y2] = spot.coords.split(',').map(Number);
const centerX = (x1 + x2) / 2;
const centerY = (y1 + y2) / 2;
marker.style.left = `${(centerX / mapImageElement.naturalWidth) * 100}%`;
marker.style.top = `${(centerY / mapImageElement.naturalHeight) * 100}%`;
const dataKey = spot.dataKey;
const displayName = spot.name;
let remainingText;
let spotData = locationData[dataKey];
if (!spotData) {
remainingText = '<strong>N/A</strong> Codes Left';
marker.style.borderColor = 'gray';
} else {
const remaining = spotData.count;
if (remaining > 0) {
remainingText = `🦆 <strong>${remaining}</strong> Codes Left`;
marker.style.borderColor = 'var(--green)';
} else {
remainingText = `❌ <strong>CLEARED</strong>`;
marker.classList.add('cleared');
}
}
marker.innerHTML = `<h4>${displayName}</h4><p>${remainingText}</p>`;
marker.addEventListener('click', (e) => {
e.stopPropagation();
document.querySelectorAll('.map-label.on-top').forEach(lbl => {
lbl.classList.remove('on-top');
});
marker.classList.add('on-top');
});
overlay.appendChild(marker);
});
isPanning = true;
updateLabelSizeOnPan();
}
async function updateDuckMapData() {
// This call now leverages the backend cache (5 minutes) for speed
const result = await postToAction('getDuckCounts');
if (result.status === 'success' && result.locations) {
locationCountsCache = {};
Object.keys(result.locations).forEach(name => {
locationCountsCache[name] = { count: result.locations[name] };
});
}
}
function initializeMap() {
if (mapResizeObserver) {
mapResizeObserver.disconnect();
mapResizeObserver = null;
}
mapCardContainer.addEventListener('scroll', () => {
if (!isPanning) {
isPanning = true;
window.requestAnimationFrame(updateLabelSizeOnPan);
}
});
const imageLoadPromise = new Promise(resolve => {
if (mapImageElement.complete && mapImageElement.naturalWidth > 0) {
resolve();
} else {
mapImageElement.onload = resolve;
mapImageElement.onerror = resolve;
}
});
Promise.all([imageLoadPromise, updateDuckMapData()]).then(() => {
if (mapImageElement.naturalWidth > 0) {
positionMarkers();
if (!mapResizeObserver) {
mapResizeObserver = new ResizeObserver(positionMarkers);
mapResizeObserver.observe(mapImageElement);
}
} else {
console.error("Map image failed to load or has zero dimensions.");
}
});
}
// --- END MAP INTERACTION LOGIC ---
// --- FETCH HELPER ---
async function postToAction(action, payload = {}) {
try {
const response = await fetch(SCRIPT_URL, {
method: 'POST',
body: JSON.stringify({ action, ...payload })
});
if (!response.ok) {
throw new Error(`Network response was not ok: ${response.statusText}`);
}
return await response.json();
} catch (error) {
console.error(`Fetch error for action "${action}":`, error);
return { status: "error", message: "Network error or script failure." };
}
}
// --- RIBBON DISPLAY FUNCTION ---
function updateRibbon(ribbonText) {
const ribbonContent = document.getElementById('ribbon-content');
const scrollSpeed = 25;
ribbonContent.style.animation = 'none';
ribbonContent.style.transform = 'translateX(0)';
ribbonContent.style.paddingLeft = '100%';
if (ribbonText && ribbonText.trim() !== '') {
ribbonContent.innerHTML = `📢<span>${ribbonText}</span>`;
ribbonMessage.classList.add('visible');
appWrapper.classList.add('ribbon-active');
setTimeout(() => {
const contentWidth = ribbonContent.scrollWidth;
const viewWidth = ribbonMessage.clientWidth;
if (contentWidth > viewWidth) {
const totalDistance = contentWidth;
const duration = totalDistance / scrollSpeed;
ribbonContent.style.setProperty('--marquee-distance', `-${totalDistance}px`);
ribbonContent.style.animation = `marquee-scroll ${duration}s linear infinite`;
ribbonContent.style.paddingLeft = `${viewWidth}px`;
ribbonContent.style.textAlign = 'left';
} else {
ribbonContent.style.paddingLeft = '0';
ribbonContent.style.textAlign = 'center';
const centeredPadding = (viewWidth - ribbonContent.offsetWidth) / 2;
ribbonContent.style.paddingLeft = `${Math.max(0, centeredPadding)}px`;
ribbonContent.style.transform = 'translateX(0)';
ribbonContent.style.animation = 'none';
}
}, 10);
} else {
ribbonContent.innerHTML = '';
ribbonMessage.classList.remove('visible');
appWrapper.classList.remove('ribbon-active');
ribbonContent.style.animation = 'none';
}
}
// --- ANIMATION FUNCTIONS ---
function startRandomFadingDuckFeet() {
const container = document.getElementById('duck-feet-background-container');
const maxFeetOnScreen = 7;
const minDelay = 1000;
const maxDelay = 3000;
const animationDuration = 6000;
function createFadingFeet() {
const currentFeet = container.querySelectorAll('.fading-duck-feet');
if (currentFeet.length >= maxFeetOnScreen) {
// Only create new feet if under the limit
setTimeout(createFadingFeet, Math.random() * (maxDelay - minDelay) + minDelay);
return;
}
const feet = document.createElement('div');
feet.className = 'fading-duck-feet';
const left = Math.random() * 100;
const top = Math.random() * 100;
const rotation = Math.random() * 360;
const delay = Math.random() * animationDuration;
feet.style.left = `${left}vw`;
feet.style.top = `${top}vh`;
feet.style.transform = `rotate(${rotation}deg)`;
feet.style.animationDuration = `${animationDuration}ms`;
feet.style.animationDelay = `-${delay}ms`;
container.appendChild(feet);
setTimeout(() => {
feet.remove();
}, animationDuration * 2); // Remove after two cycles to prevent accumulation
setTimeout(createFadingFeet, Math.random() * (maxDelay - minDelay) + minDelay);
}
// Start the cycle
createFadingFeet();
}
function createGoldenFlash() {
const flash = document.getElementById('golden-flash-overlay');
flash.classList.remove('hidden');
flash.style.animation = 'none';
// Trigger reflow
void flash.offsetWidth;
flash.style.animation = 'gold-flash 2s ease-out forwards';
setTimeout(() => {
flash.classList.add('hidden');
}, 2000);
}
function createPointPop(message, isGolden = false) {
const container = document.getElementById('hunt-content-wrapper');
const pop = document.createElement('div');
pop.className = 'point-pop';
if (isGolden) {
pop.classList.add('golden-point-pop');
createGoldenFlash();
}
pop.textContent = message;
container.appendChild(pop);
pop.addEventListener('animationend', () => {
pop.remove();
});
}
function createFlyingDuck() {
const duck = document.createElement('div');
duck.className = 'duck-animation';
duck.textContent = '🦆';
document.body.appendChild(duck);
duck.style.top = `${Math.random() * 50 + 20}vh`; // Start between 20% and 70% of viewport height
duck.addEventListener('animationend', () => {
duck.remove();
});
}
function createFrostFall() {
const frost = document.createElement('div');
frost.className = 'frost-animation';
frost.textContent = '❄️';
document.body.appendChild(frost);
const startLeft = Math.random() * 100;
const duration = Math.random() * 5 + 5; // 5 to 10 seconds
const size = Math.random() * 1.5 + 1; // 1.0 to 2.5 rem
frost.style.left = `${startLeft}vw`;
frost.style.fontSize = `${size}rem`;
frost.style.animationDuration = `${duration}s`;
frost.addEventListener('animationend', () => {
frost.remove();
});
}
// --- END ANIMATION FUNCTIONS ---
// --- REGISTRATION / AUTH LOGIC ---
function showScreen(screenId) {
document.querySelectorAll('.screen').forEach(screen => {
screen.classList.remove('visible');
});
document.getElementById(screenId).classList.add('visible');
}
function validateRegistration(firstName, lastName, studentId, email) {
if (!firstName || !lastName || !studentId || !email) {
showNotification('All fields are required.', true);
return false;
}
if (!/^\d{8}$/.test(studentId)) {
showNotification('Student ID must be an 8-digit number.', true);
return false;
}
if (!email.toLowerCase().endsWith('@my.gcu.edu')) {
showNotification('Email must end with @my.gcu.edu.', true);
return false;
}
if (!document.getElementById('terms-checkbox').checked) {
showNotification('You must agree to the Terms & Conditions.', true);
return false;
}
return true;
}
async function registerUser(firstName, lastName, studentId, email) {
const submitBtn = document.getElementById('submit-btn');
submitBtn.disabled = true;
submitBtn.innerHTML = '<div class="spinner"></div> Registering...';
const result = await postToAction('registerUser', {
firstName, lastName, studentId, email
});
submitBtn.disabled = false;
submitBtn.innerHTML = 'Submit';
if (result.status === 'success') {
showNotification('Registration successful! Please sign in.', false);
document.getElementById('login-studentid').value = studentId;
document.getElementById('registration-view').classList.add('hidden');
document.getElementById('login-view').classList.remove('hidden');
} else {
showNotification(result.message || 'Registration failed due to a server error.', true);
}
}
async function signInUser(studentId) {
const signInBtn = document.getElementById('signin-btn');
signInBtn.disabled = true;
signInBtn.innerHTML = '<div class="spinner"></div> Signing In...';
const result = await postToAction('signInUser', { studentId });
signInBtn.disabled = false;
signInBtn.innerHTML = 'Sign In';
if (result.status === 'success' && result.user) {
currentUser = result.user;
localStorage.setItem('currentUser', JSON.stringify(currentUser));
localStorage.setItem('lastLoginId', studentId);
initializeHunt();
showScreen('app-wrapper');
} else {
currentUser = null;
showNotification(result.message || 'Sign in failed. Check your ID or register.', true);
}
}
function signOutUser() {
if (html5QrCode && html5QrCode.isScanning) {
stopScanner();
}
currentUser = null;
localStorage.removeItem('currentUser');
localStorage.removeItem(getQueueKey());
localStorage.removeItem('localVirtualScanTimestamps');
clearTimeoutsAndIntervals();
locationCountsCache = {};
claimedDucksCache.clear();
scanQueue = [];
pendingPoints = 0;
pendingDucks = 0;
updateOptimisticDisplay();
showScreen('login-screen');
}
// --- DATA FETCH / SYNC LOGIC ---
async function fetchInitialData() {
if (!currentUser) return;
const result = await postToAction('getInitialData', { studentId: currentUser.studentId });
if (result.status === 'success') {
// Update User Stats
currentUser.points = result.user.points || 0;
currentUser.ducksFound = result.user.ducksFound || 0;
currentUser.rank = result.user.rank || 'N/A';
currentUser.totalPlayers = result.user.totalPlayers || 0;
document.getElementById('welcome-message').textContent = `Welcome, ${currentUser.firstName}!`;
// Update Duck Data Cache
if (result.duckData) {
duckDataCache = result.duckData;
// Use a more efficient structure to map IDs to points/type
Object.keys(duckDataCache).forEach(id => {
duckDataCache[id.toLowerCase()] = duckDataCache[id];
});
}
// Update Claimed Ducks Cache
claimedDucksCache.clear();
if (result.claimedDucks) {
result.claimedDucks.forEach(id => claimedDucksCache.add(id.toLowerCase()));
}
// Update Virtual Scan Timestamps
localVirtualScanTimestamps = result.virtualScans || [];
// Update Ribbon
updateRibbon(result.ribbonMessage || '');
// Refresh all UI components
updatePlayerStatsUI();
renderInfoCards();
renderLeaderboard(result.leaderboard || []);
renderLog(result.log || []);
updateLogListFooter(result.log.length);
// Load any local queue after fetching server-side claimed ducks
loadScanQueue();
} else {
showNotification(result.message || 'Failed to fetch initial data.', true);
// Optionally sign out if there's a critical auth error
if (result.message && result.message.includes('not found')) {
signOutUser();
}
}
}
function updatePlayerStatsUI() {
const totalPoints = currentUser.points + pendingPoints;
const totalDucks = currentUser.ducksFound + pendingDucks;
document.getElementById('player-points').textContent = totalPoints;
document.getElementById('player-ducks').textContent = totalDucks;
const rankText = currentUser.rank !== 'N/A' && currentUser.totalPlayers > 0
? `Rank: ${currentUser.rank} / ${currentUser.totalPlayers}`
: 'Rank: N/A';
document.getElementById('player-rank-display').textContent = rankText;
// Flash the UI element if there's a pending update
const pointsElem = document.getElementById('player-points');
const ducksElem = document.getElementById('player-ducks');
if (pendingPoints > 0 || pendingDucks > 0) {
pointsElem.classList.add('pending-update');
ducksElem.classList.add('pending-update');
} else {
pointsElem.classList.remove('pending-update');
ducksElem.classList.remove('pending-update');
}
}
function updateOptimisticDisplay() {
updatePlayerStatsUI();
}
async function processScanQueue() {
if (scanQueue.length === 0 || !currentUser) {
return;
}
// Prevent concurrent processing
if (scanQueue.isProcessing) {
return;
}
scanQueue.isProcessing = true;
const scansToSend = scanQueue;
scanQueue = [];
saveScanQueue(); // Save the now-empty queue
console.log(`Sending batch of ${scansToSend.length} scans...`);
const result = await postToAction('processScanBatch', {
studentId: currentUser.studentId,
scans: scansToSend
});
scanQueue.isProcessing = false;
if (result.status === 'success') {
// Reset optimistic count based on what was successfully sent
scansToSend.forEach(scan => {
const duckInfo = duckDataCache[scan.duckId.trim().toLowerCase()];
if (duckInfo) {
pendingPoints -= duckInfo.points || 0;
pendingDucks -= 1;
}
});
// Ensure pending is never negative
pendingPoints = Math.max(0, pendingPoints);
pendingDucks = Math.max(0, pendingDucks);
// Full refresh of data to get accurate totals, leaderboard, and log
await fetchInitialData();
updateOptimisticDisplay();
showNotification(`${scansToSend.length} scans processed successfully!`);
} else {
// Failed to send, put scans back at the front of the queue
scanQueue = scansToSend.concat(scanQueue);
saveScanQueue();
showNotification(result.message || `Failed to process ${scansToSend.length} scans. Retrying soon.`, true);
// Re-apply optimistic count since they are back in the queue
scansToSend.forEach(scan => {
const duckInfo = duckDataCache[scan.duckId.trim().toLowerCase()];
if (duckInfo) {
pendingPoints += duckInfo.points || 0;
pendingDucks += 1;
}
});
updateOptimisticDisplay();
}
}
// --- SCANNER / HUNT LOGIC ---
function isDuckLink(url) {
// A valid duck QR code should contain the base script URL and a duckId parameter
const duckIdRegex = new RegExp(SCRIPT_URL.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') + '.*duckId=([^&]+)', 'i');
return duckIdRegex.test(url);
}
function extractDuckId(url) {
const urlObj = new URL(url);
return urlObj.searchParams.get('duckId');
}
function isVirtualDuck(duckId) {
const duckIdLower = duckId.toLowerCase();
return VIRTUAL_LOCATIONS.some(loc => duckIdLower.includes(loc.toLowerCase()));
}
function canScanVirtualDuck() {
const today = new Date().toISOString().split('T')[0];
// Filter for scans today
localVirtualScanTimestamps = localVirtualScanTimestamps.filter(timestamp => {
return timestamp.startsWith(today);
});
// Check limit
return localVirtualScanTimestamps.length < VIRTUAL_LIMIT;
}
function handleScanSuccess(decodedText) {
if (!isDuckLink(decodedText)) {
flashScannerError('Not a Duck Hunt QR Code');
return;
}
const duckId = extractDuckId(decodedText);
if (!duckId) {
flashScannerError('Invalid Duck Code Link');
return;
}
const duckIdKey = duckId.trim().toLowerCase();
if (processingDucks.has(duckIdKey)) {
flashScannerError('Duck is already processing.');
return;
}
if (claimedDucksCache.has(duckIdKey)) {
flashScannerError('Duck already claimed!');
return;
}
const isVirtual = isVirtualDuck(duckId);
if (isVirtual && !canScanVirtualDuck()) {
flashScannerError(`Virtual Duck Limit (${VIRTUAL_LIMIT}) Reached for Today!`);
return;
}
// Optimistic update
processingDucks.add(duckIdKey);
const duckInfo = duckDataCache[duckIdKey];
const points = duckInfo ? duckInfo.points : (isVirtual ? 25 : 100);
const duckType = duckInfo ? duckInfo.type : (isVirtual ? 'Virtual Duck' : 'Unknown Duck');
const isGolden = duckType.includes('Golden');
// Add to local scan queue
scanQueue.push({ duckId, timestamp: new Date().toISOString() });
saveScanQueue();
// Apply optimistic points
pendingPoints += points;
pendingDucks += 1;
updateOptimisticDisplay();
// Add to local virtual scan history (if virtual)
if (isVirtual) {
localVirtualScanTimestamps.push(new Date().toISOString());
localStorage.setItem('localVirtualScanTimestamps', JSON.stringify(localVirtualScanTimestamps));
}
// User Feedback
createPointPop(`+${points} Points! (${duckType})`, isGolden);
if (isGolden) {
createFlyingDuck(); // A celebratory animation for Golden Ducks
} else if (!isVirtual) {
// Minor visual feedback for normal physical ducks
createFrostFall();
}
flashScannerSuccess();
// Force immediate processing
processScanQueue();
// Prevent immediate re-scan of this ID while waiting for server response
setTimeout(() => {
processingDucks.delete(duckIdKey);
// We rely on fetchInitialData to update claimedDucksCache and verify the scan
}, BATCH_SEND_INTERVAL_MS);
}
function flashScannerSuccess() {
const container = document.getElementById('qr-reader-container');
container.style.boxShadow = 'var(--glass-shadow), 0 0 25px var(--glow-color)';
setTimeout(() => {
container.style.boxShadow = 'var(--glass-shadow)';
}, 200);
}
function flashScannerError(message) {
const container = document.getElementById('qr-reader-container');
container.classList.add('error-flash');
showNotification(message, true);
setTimeout(() => {
container.classList.remove('error-flash');
}, 500);
}
async function startScanner() {
if (!html5QrCode) {
html5QrCode = new Html5Qrcode("qr-reader");
}
const qrCodeConfig = {
fps: 10,
qrbox: { width: 250, height: 250 },
// Use back camera if available, otherwise default
facingMode: "environment"
};
try {
const cameraList = await Html5Qrcode.getCameras();
let cameraId = null;
if (cameraList && cameraList.length) {
// Attempt to find the back camera
const backCamera = cameraList.find(camera => camera.label.toLowerCase().includes('back') || camera.label.toLowerCase().includes('environment'));
cameraId = backCamera ? backCamera.id : cameraList[0].id;
}
await html5QrCode.start(
cameraId || { facingMode: "environment" },
qrCodeConfig,
handleScanSuccess,
(errorMessage) => {
// Optional: do nothing on scan failure, avoids spamming console
}
);
// Get video track for torch control
const videoElement = document.getElementById('qr-reader').querySelector('video');
if (videoElement && videoElement.srcObject) {
cameraTrack = videoElement.srcObject.getVideoTracks()[0];
document.getElementById('torch-toggle-btn').classList.remove('hidden');
}
} catch (err) {
console.error("Failed to start QR scanner: ", err);
showNotification("Failed to start camera. Please ensure camera permissions are granted.", true);
// Fallback to simpler start without explicit camera ID
try {
await html5QrCode.start(
{ facingMode: "environment" },
qrCodeConfig,
handleScanSuccess,
(errorMessage) => {}
);
const videoElement = document.getElementById('qr-reader').querySelector('video');
if (videoElement && videoElement.srcObject) {
cameraTrack = videoElement.srcObject.getVideoTracks()[0];
document.getElementById('torch-toggle-btn').classList.remove('hidden');
}
} catch(e) {
console.error("Failed on fallback start: ", e);
showNotification("Failed to start camera. Try restarting the app.", true);
}
}
}
function stopScanner() {
if (html5QrCode && html5QrCode.isScanning) {
html5QrCode.stop().then(() => {
console.log("QR Code scanning stopped.");
document.getElementById('torch-toggle-btn').classList.add('hidden');
isTorchOn = false;
document.getElementById('torch-toggle-btn').classList.remove('torch-on');
cameraTrack = null;
}).catch(err => {
console.error("Error stopping QR code scanner:", err);
});
}
}
async function toggleTorch() {
if (!cameraTrack || !cameraTrack.getCapabilities().torch) {
showNotification("Torch not available on this camera.", true);
return;
}
try {
await cameraTrack.applyConstraints({
advanced: [{ torch: !isTorchOn }]
});
isTorchOn = !isTorchOn;
document.getElementById('torch-toggle-btn').classList.toggle('torch-on', isTorchOn);
} catch (err) {
console.error("Error toggling torch:", err);
showNotification("Failed to toggle torch.", true);
}
}
// --- UI RENDERING & UTILITIES ---
function renderLog(logData) {
const logList = document.getElementById('log-list');
logList.innerHTML = '';
if (!logData || logData.length === 0) {
logList.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No scans recorded yet.</p>';
return;
}
logData.forEach(entry => {
const listItem = document.createElement('li');
listItem.className = 'list-item glass-card';
const date = new Date(entry.timestamp);
const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
let icon = '🦆';
if (entry.type.includes('Golden')) { icon = '🥇'; }
else if (entry.type.includes('Engagement')) { icon = '👑'; }
else if (entry.type.includes('Virtual')) { icon = '💻'; }
listItem.innerHTML = `
<div>
<p class="primary-text">${icon} ${entry.type}</p>
<p class="secondary-text">${formattedDate} at ${formattedTime}</p>
</div>
<span style="color: ${entry.type.includes('Golden') ? 'var(--gold)' : 'var(--green)'}">+${entry.points}</span>
`;
logList.appendChild(listItem);
});
}
function renderLeaderboard(leaderboardData) {
const leaderboardList = document.getElementById('leaderboard-list');
leaderboardList.innerHTML = '';
if (!leaderboardData || leaderboardData.length === 0) {
leaderboardList.innerHTML = '<p style="color: rgba(255,255,255,0.7);">Leaderboard data is currently unavailable.</p>';
return;
}
leaderboardData.forEach((entry, index) => {
const listItem = document.createElement('li');
listItem.className = 'list-item glass-card';
const rank = index + 1;
let rankIcon = '';
let rankStyle = '';
if (rank === 1) { rankIcon = '🥇'; rankStyle = 'color: var(--gold);'; }
else if (rank === 2) { rankIcon = '🥈'; rankStyle = 'color: silver;'; }
else if (rank === 3) { rankIcon = '🥉'; rankStyle = 'color: #cd7f32;'; }
listItem.innerHTML = `
<div>
<div class="rank-text" style="${rankStyle}">${rankIcon} #${rank}</div>
<p style="font-weight: 500;">${entry.displayName}</p>
</div>
<span>${entry.points}</span>
`;
leaderboardList.appendChild(listItem);
});
// Highlight the current user's rank on the leaderboard
const currentUserDisplayName = currentUser ? `${currentUser.firstName} ${currentUser.lastName[0]}.` : '';
document.querySelectorAll('#leaderboard-list .list-item p').forEach(p => {
if (p.textContent === currentUserDisplayName) {
p.closest('.list-item').style.border = '2px solid var(--green)';
p.closest('.list-item').style.boxShadow = 'var(--active-glow)';
}
});
}
function renderInfoCards() {
const container = document.getElementById('info-container');
container.innerHTML = '';
infoDataCache.forEach((item, index) => {
const button = document.createElement('button');
button.className = 'info-card-button glass-card full-width-btn secondary-btn';
button.setAttribute('data-info-index', index);
button.innerHTML = `<h4>${item.title}</h4>`;
container.appendChild(button);
});
}
function showModal(index) {
const data = infoDataCache[index];
if (!data) return;
const modalTitle = document.getElementById('modal-title');
const modalContent = document.getElementById('modal-content');
modalTitle.textContent = data.title;
modalContent.innerHTML = '';
// Content is either a single string or an array of strings/HTML
const contentArray = Array.isArray(data.content) ? data.content : [data.content];
contentArray.forEach(item => {
if (item.startsWith('<iframe')) {
modalContent.insertAdjacentHTML('beforeend', item);
} else if (item.startsWith('#')) {
const h3 = document.createElement('h3');
h3.textContent = item.substring(1).trim();
modalContent.appendChild(h3);
} else if (item.startsWith('*')) {
const ul = document.createElement('ul');
const items = item.split('*').filter(s => s.trim() !== '');
items.forEach(liText => {
const li = document.createElement('li');
li.innerHTML = liText.trim();
ul.appendChild(li);
});
modalContent.appendChild(ul);
} else if (item.trim() === '') {
modalContent.appendChild(document.createElement('br'));
} else {
const p = document.createElement('p');
p.innerHTML = item.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
modalContent.appendChild(p);
}
});
document.getElementById('info-modal-backdrop').style.display = 'flex';
}
function hideModal() {
document.getElementById('info-modal-backdrop').style.display = 'none';
}
function showNotification(message, isError = false) {
const notification = document.getElementById('ribbon-message');
const content = document.getElementById('ribbon-content');
content.innerHTML = `📣<span>${message}</span>`;
notification.classList.remove('error-ribbon');
if (isError) {
notification.style.backgroundColor = 'rgba(150, 20, 20, 0.8)'; // Red for error
content.style.color = 'white';
} else {
notification.style.backgroundColor = 'rgba(30, 30, 30, 0.5)'; // Default
content.style.color = 'var(--gold)';
}
notification.classList.add('visible');
appWrapper.classList.add('ribbon-active');
// Stop marquee animation for static message
content.style.animation = 'none';
content.style.transform = 'translateX(0)';
content.style.paddingLeft = '0';
content.style.textAlign = 'center';
setTimeout(() => {
// After a delay, revert to the initial ribbon message if it exists
fetchInitialData(); // Re-fetch data to get the latest marquee message
// If the full refresh takes too long, just hide it after a few seconds
setTimeout(() => {
if (notification.style.backgroundColor !== 'rgba(30, 30, 30, 0.5)') {
// Only hide if the re-fetch hasn't kicked in and replaced it
updateRibbon(ribbonMessage.textContent || '');
}
}, 5000);
}, 3000); // Wait 3 seconds before trying to revert
}
function updateLogListFooter(logCount) {
const logContainer = document.getElementById('log-container');
let footer = document.getElementById('log-list-footer');
if (!footer) {
footer = document.createElement('p');
footer.id = 'log-list-footer';
footer.style.textAlign = 'center';
footer.style.marginTop = '1rem';
footer.style.color = 'rgba(255,255,255,0.7)';
logContainer.appendChild(footer);
}
footer.textContent = `Total scans: ${logCount}`;
}
// --- INITIALIZATION & LIFECYCLE ---
function clearTimeoutsAndIntervals() {
if (batchSendTimer) {
clearInterval(batchSendTimer);
batchSendTimer = null;
}
if (dataRefreshTimer) {
clearInterval(dataRefreshTimer);
dataRefreshTimer = null;
}
}
function initializeHunt() {
clearTimeoutsAndIntervals();
fetchInitialData();
batchSendTimer = setInterval(processScanQueue, BATCH_SEND_INTERVAL_MS);
dataRefreshTimer = setInterval(fetchInitialData, DATA_REFRESH_INTERVAL_MS);
// Initialize the map once all data is ready
initializeMap();
startRandomFadingDuckFeet();
}
function setupEventListeners() {
// --- Login/Registration Listeners ---
document.getElementById('signin-btn').addEventListener('click', () => {
const studentId = document.getElementById('login-studentid').value.trim();
if (studentId) signInUser(studentId);
else showNotification('Please enter your Student ID.', true);
});
document.getElementById('register-btn').addEventListener('click', () => {
document.getElementById('login-view').classList.add('hidden');
document.getElementById('registration-view').classList.remove('hidden');
});
document.getElementById('back-btn').addEventListener('click', () => {
document.getElementById('registration-view').classList.add('hidden');
document.getElementById('login-view').classList.remove('hidden');
});
document.getElementById('submit-btn').addEventListener('click', () => {
const firstName = document.getElementById('reg-firstname').value.trim();
const lastName = document.getElementById('reg-lastname').value.trim();
const studentId = document.getElementById('reg-studentid').value.trim();
const email = document.getElementById('reg-email').value.trim();
if (validateRegistration(firstName, lastName, studentId, email)) {
registerUser(firstName, lastName, studentId, email);
}
});
document.getElementById('what-is-duck-hunt-link').addEventListener('click', (e) => {
e.preventDefault();
showModal(4); // Index 4 is "What is Duck Hunt?"
});
document.getElementById('view-terms-link').addEventListener('click', (e) => {
e.preventDefault();
showModal(3); // Index 3 is "Terms & Conditions"
});
document.getElementById('close-instructions').addEventListener('click', () => {
document.getElementById('instructions-card').classList.add('hidden');
});
// --- App Listeners ---
document.getElementById('scan-history-link').addEventListener('click', (e) => {
e.preventDefault();
navigateToPage('log-page');
});
document.getElementById('torch-toggle-btn').addEventListener('click', toggleTorch);
document.getElementById('logout-btn').addEventListener('click', signOutUser);
// Tab Bar Navigation
document.querySelectorAll('.tab-button').forEach(button => {
button.addEventListener('click', (e) => {
const pageId = e.currentTarget.getAttribute('data-page');
navigateToPage(pageId);
});
});
// Info Modal Delegation
document.getElementById('info-container').addEventListener('click', (e) => {
const button = e.target.closest('.info-card-button');
if (button) {
const index = parseInt(button.getAttribute('data-info-index'));
showModal(index);
}
});
document.getElementById('modal-close-btn').addEventListener('click', hideModal);
document.getElementById('info-modal-backdrop').addEventListener('click', (e) => {
if (e.target === e.currentTarget) {
hideModal();
}
});
}
function navigateToPage(pageId) {
document.querySelectorAll('.app-page').forEach(page => page.classList.remove('active'));
document.getElementById(pageId).classList.add('active');
document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
document.querySelector(`.tab-button[data-page="${pageId}"]`).classList.add('active');
if (pageId === 'hunt-page') {
startScanner();
} else {
stopScanner();
}
if (pageId === 'map-page') {
initializeMap();
}
// Scroll to top of the content area
document.getElementById('app-container').scrollTop = 0;
}
function initializeApp() {
setupEventListeners();
// Check for stored user session
const storedUser = localStorage.getItem('currentUser');
const lastLoginId = localStorage.getItem('lastLoginId');
if (storedUser) {
try {
currentUser = JSON.parse(storedUser);
document.getElementById('login-studentid').value = currentUser.studentId || lastLoginId || '';
initializeHunt();
showScreen('app-wrapper');
navigateToPage('hunt-page');
} catch (e) {
console.error("Error parsing stored user:", e);
localStorage.removeItem('currentUser');
showScreen('login-screen');
}
} else {
document.getElementById('login-studentid').value = lastLoginId || '';
showScreen('login-screen');
// Hide instructions card after initial load
setTimeout(() => {
document.getElementById('instructions-card').classList.add('hidden');
}, 5000);
}
}
window.onload = initializeApp;
</script>
</body>
</html>
